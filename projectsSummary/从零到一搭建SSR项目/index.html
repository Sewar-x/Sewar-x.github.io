<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>从零到一搭建SSR项目 | Sewen 博客</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="./mylogo.png">
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
    <link rel="manifest" href="/myblog/manifest.webmanifest" crossorigin="use-credentials">
    <link rel="alternate" type="application/atom+xml" href="https://sewar-x.github.io/myblog/atom.xml" title="Sewen 博客 Atom Feed">
    <link rel="alternate" type="application/json" href="https://sewar-x.github.io/myblog/rss.xml" title="Sewen 博客 JSON Feed">
    <link rel="alternate" type="application/rss+xml" href="https://sewar-x.github.io/myblog/rss.xml" title="Sewen 博客 RSS Feed">
    <meta name="description" content="sewen 的前端学习笔记、博客、前端基础总结、技术深度剖析、面试题总结、算法总结、项目过程总结">
    <meta property="og:url" content="https://sewar-x.github.io/myblog/projectsSummary/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BASSR%E9%A1%B9%E7%9B%AE.html">
    <meta property="og:site_name" content="Sewen 博客">
    <meta property="og:title" content="从零到一搭建SSR项目">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="en-US">
    <meta name="theme-color" content="#46bd87">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <link rel="preload" href="/myblog/assets/css/0.styles.645fbc6f.css" as="style"><link rel="preload" href="/myblog/assets/js/app.9d2b617a.js" as="script"><link rel="preload" href="/myblog/assets/js/layout-Layout.d2d4ce64.js" as="script"><link rel="preload" href="/myblog/assets/js/page-从零到一搭建SSR项目.855376fc.js" as="script"><link rel="preload" href="/myblog/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound~layout-components/Blog/BlogHome~layout-components/~2222f443.5835591a.js" as="script"><link rel="prefetch" href="/myblog/assets/js/199.a9216960.js"><link rel="prefetch" href="/myblog/assets/js/200.4c66fc79.js"><link rel="prefetch" href="/myblog/assets/js/layout-Blog.1fca7e90.js"><link rel="prefetch" href="/myblog/assets/js/layout-NotFound.3c74e8aa.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/AlgoliaSearch/Dropdown.70fcebe7.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/Anchor.3235541c.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/Blog/ArticleInfo.7b815b20.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/Blog/ArticleItem.b0e177e1.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/Blog/ArticleList.d1cf1b24.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/Blog/ArticleType.b630b80e.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/Blog/BlogHero.621312ba.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/Blog/BlogHome.4fe44489.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/Blog/BlogInfo.b2a94760.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/Blog/BlogPage.e0fbe820.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/Blog/BloggerInfo.0df38355.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/Blog/CategoryList.ec1bcd96.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/Blog/ProjectList.8550a110.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/Blog/TagList.bcf7b782.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/Blog/Timeline.b6cf5471.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/Blog/TimelineList.3c6e08a6.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/Clipboard.e940a903.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/Common.820a8694.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/Home.70383986.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/MyTransition.0de46069.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/Navbar/DropdownLink.e3f6c118.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/Navbar/NavLink.93b11770.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/Navbar/NavLinks.8ba214e6.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/Navbar/Navbar.b90a94f9.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/Navbar/RepoLink.663a7f55.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/Navbar/SidebarButton.76b0035a.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/Page.98b5d09c.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/PageFooter.20bc9bd8.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/PageMeta.b7e6b12f.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/PageNav.8305dd1f.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/Password.45e0e82a.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/Sidebar/DropdownTransition.068c5eea.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/Sidebar/Sidebar.f6f90d52.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/Sidebar/SidebarDropdownLink.505127a8.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/Sidebar/SidebarGroup.7eecf370.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/Sidebar/SidebarLink.6e39fe32.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/Sidebar/SidebarNavLinks.0f8566cb.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/Theme/DarkmodeSwitch.20ac7b92.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/Theme/ThemeColor.6086e4ed.js"><link rel="prefetch" href="/myblog/assets/js/layout-components/Theme/ThemeOptions.483238c9.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/ArticleIcon.0a22e2b1.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/AutoIcon.2ff1c790.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/BookIcon.419b49ba.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/DarkIcon.7d81873b.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/EditIcon.8ada485d.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/EmptyIcon.d704a5cf.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/I18nIcon.ffad8b3e.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/LightIcon.47d807da.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/LinkIcon.1a8a7826.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/LockIcon.a29a2b79.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/NextIcon.0214ee59.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/Page404Icon.8bc1ebbb.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/PresentationIcon.17500d9b.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/PrevIcon.2ae04a70.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/ProjectIcon.b336d567.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/StickyIcon.0f509b9d.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/media/Baidu.244b9a41.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/media/Bitbucket.11ba94e1.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/media/Dingding.e8a3d90d.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/media/Discord.3295a55b.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/media/Dribbble.464dac3b.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/media/Email.f9254caa.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/media/Evernote.991472fb.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/media/Facebook.08e78e47.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/media/Flipboard.a1124d0f.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/media/Gitee.c44bc20a.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/media/Github.5667e5ae.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/media/Gitlab.ad95c7a7.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/media/Gmail.b5acc6bc.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/media/Instagram.56be85f2.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/media/Lines.d9db3dce.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/media/Linkedin.b82d8d8b.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/media/Pinterest.0f3ffe71.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/media/Pocket.41ef3c92.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/media/QQ.7558f4ba.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/media/Qzone.bf658fae.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/media/Reddit.9c4c95ee.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/media/Rss.9780139e.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/media/Steam.06abbae2.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/media/Twitter.26fa5bda.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/media/Wechat.9cac8c4c.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/media/Weibo.5206a632.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/media/Whatsapp.0738f1e3.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/media/Youtube.f41fd7f2.js"><link rel="prefetch" href="/myblog/assets/js/layout-icons/media/Zhihu.4d851d2f.js"><link rel="prefetch" href="/myblog/assets/js/page--0abc50bf.0d6f1484.js"><link rel="prefetch" href="/myblog/assets/js/page--1cd40f4c.dd76c7b3.js"><link rel="prefetch" href="/myblog/assets/js/page--53f93199.e80bdec8.js"><link rel="prefetch" href="/myblog/assets/js/page--5afd2fd0.adea4e92.js"><link rel="prefetch" href="/myblog/assets/js/page--67c584d3.0a3f3cd9.js"><link rel="prefetch" href="/myblog/assets/js/page--776a8506.cdf48aac.js"><link rel="prefetch" href="/myblog/assets/js/page-CSS.eb94b29f.js"><link rel="prefetch" href="/myblog/assets/js/page-Chrome开发工具使用指南.a2675120.js"><link rel="prefetch" href="/myblog/assets/js/page-DevServer.0281863d.js"><link rel="prefetch" href="/myblog/assets/js/page-Echarts二次封装.4387b8ad.js"><link rel="prefetch" href="/myblog/assets/js/page-Elementui与Element-plusui二次封装.82f12a09.js"><link rel="prefetch" href="/myblog/assets/js/page-Git基础.03c616ad.js"><link rel="prefetch" href="/myblog/assets/js/page-Git规范.e2fdc38a.js"><link rel="prefetch" href="/myblog/assets/js/page-HTML.1e3c14b9.js"><link rel="prefetch" href="/myblog/assets/js/page-Home.f0b7e772.js"><link rel="prefetch" href="/myblog/assets/js/page-JSON配置化组件二次封装.12060fd9.js"><link rel="prefetch" href="/myblog/assets/js/page-JS原理实现.3c427e19.js"><link rel="prefetch" href="/myblog/assets/js/page-JS应用题.3d313b34.js"><link rel="prefetch" href="/myblog/assets/js/page-JavaScript基础.551be887.js"><link rel="prefetch" href="/myblog/assets/js/page-Linux.c6159ebd.js"><link rel="prefetch" href="/myblog/assets/js/page-Loader和Plugin原理.b2971b76.js"><link rel="prefetch" href="/myblog/assets/js/page-MySQL.0b1d704a.js"><link rel="prefetch" href="/myblog/assets/js/page-NPM.a55851b2.js"><link rel="prefetch" href="/myblog/assets/js/page-Node.ec405a21.js"><link rel="prefetch" href="/myblog/assets/js/page-Nodejs常见问题集合.12844e69.js"><link rel="prefetch" href="/myblog/assets/js/page-Node性能优化.b4ea1c34.js"><link rel="prefetch" href="/myblog/assets/js/page-Promise专题.7869a31b.js"><link rel="prefetch" href="/myblog/assets/js/page-React.d76cf0ac.js"><link rel="prefetch" href="/myblog/assets/js/page-SSG移动端项目实践.2122615b.js"><link rel="prefetch" href="/myblog/assets/js/page-TypeScript.4f597fda.js"><link rel="prefetch" href="/myblog/assets/js/page-Vite.637881bf.js"><link rel="prefetch" href="/myblog/assets/js/page-Vite原理解析.6677fdb4.js"><link rel="prefetch" href="/myblog/assets/js/page-Vue25项目webpack构建分析.7bbea0fa.js"><link rel="prefetch" href="/myblog/assets/js/page-Vue2VsVue3.10be4140.js"><link rel="prefetch" href="/myblog/assets/js/page-Vue2x原理源码分析.e9e753b6.js"><link rel="prefetch" href="/myblog/assets/js/page-Vue3基础.210247ff.js"><link rel="prefetch" href="/myblog/assets/js/page-Vue3源码分析.17379e04.js"><link rel="prefetch" href="/myblog/assets/js/page-VueCli源码分析.afc3c83f.js"><link rel="prefetch" href="/myblog/assets/js/page-VueRouter原理分析.0a092eb6.js"><link rel="prefetch" href="/myblog/assets/js/page-VueSSR原理分析.63006040.js"><link rel="prefetch" href="/myblog/assets/js/page-VueVsReact.2156be28.js"><link rel="prefetch" href="/myblog/assets/js/page-Vuex原理分析.5ba3e6e4.js"><link rel="prefetch" href="/myblog/assets/js/page-WEB安全.5aa0eeef.js"><link rel="prefetch" href="/myblog/assets/js/page-WebPack构建原理.9c29703e.js"><link rel="prefetch" href="/myblog/assets/js/page-webpackAPI分析.4c8b152b.js"><link rel="prefetch" href="/myblog/assets/js/page-webpack优化.dcc6c3bc.js"><link rel="prefetch" href="/myblog/assets/js/page-webpack基础.3820ee6c.js"><link rel="prefetch" href="/myblog/assets/js/page-webpack项目实践.77e22417.js"><link rel="prefetch" href="/myblog/assets/js/page-一次后台管理系统的性能优化.7c2d8712.js"><link rel="prefetch" href="/myblog/assets/js/page-从零到一搭建Vue2项目和规范设计.93017fd2.js"><link rel="prefetch" href="/myblog/assets/js/page-从零到一搭建Vue3单页面应用.de152d54.js"><link rel="prefetch" href="/myblog/assets/js/page-从零到一搭建公共组件库.93278073.js"><link rel="prefetch" href="/myblog/assets/js/page-从零到一搭建移动端SSG项目.9c113d06.js"><link rel="prefetch" href="/myblog/assets/js/page-使用docker部署Node服务.5cf328fd.js"><link rel="prefetch" href="/myblog/assets/js/page-分治.e3dfc22d.js"><link rel="prefetch" href="/myblog/assets/js/page-前端发版静态资源404问题.9eb1ca89.js"><link rel="prefetch" href="/myblog/assets/js/page-前端存储.cd82cf54.js"><link rel="prefetch" href="/myblog/assets/js/page-前端工程化.1e6e58d0.js"><link rel="prefetch" href="/myblog/assets/js/page-前端性能优化方案.83718d22.js"><link rel="prefetch" href="/myblog/assets/js/page-前端架构实践.171dbc0f.js"><link rel="prefetch" href="/myblog/assets/js/page-前端渲染架构.3b783de8.js"><link rel="prefetch" href="/myblog/assets/js/page-前端自动部署.5076846c.js"><link rel="prefetch" href="/myblog/assets/js/page-前端部署原理.82ecd8a7.js"><link rel="prefetch" href="/myblog/assets/js/page-动态规划.a3af92f1.js"><link rel="prefetch" href="/myblog/assets/js/page-哈希表.c76000e8.js"><link rel="prefetch" href="/myblog/assets/js/page-回溯算法.cd914c32.js"><link rel="prefetch" href="/myblog/assets/js/page-图.dfd9828a.js"><link rel="prefetch" href="/myblog/assets/js/page-基础.7bf5a37b.js"><link rel="prefetch" href="/myblog/assets/js/page-堆.4657e538.js"><link rel="prefetch" href="/myblog/assets/js/page-字符串.252f2a08.js"><link rel="prefetch" href="/myblog/assets/js/page-异步编程.904f4c65.js"><link rel="prefetch" href="/myblog/assets/js/page-性能优化指标和监控.f2175836.js"><link rel="prefetch" href="/myblog/assets/js/page-排序算法.c7a51b99.js"><link rel="prefetch" href="/myblog/assets/js/page-搭建低代码平台.19eaf5ec.js"><link rel="prefetch" href="/myblog/assets/js/page-操作系统.473c4281.js"><link rel="prefetch" href="/myblog/assets/js/page-数学运算.c82748fb.js"><link rel="prefetch" href="/myblog/assets/js/page-数据结构算法.84480586.js"><link rel="prefetch" href="/myblog/assets/js/page-数组.692b0d0a.js"><link rel="prefetch" href="/myblog/assets/js/page-权限管理.c7e10db0.js"><link rel="prefetch" href="/myblog/assets/js/page-查找.790e52df.js"><link rel="prefetch" href="/myblog/assets/js/page-栈和队列.8dbc3586.js"><link rel="prefetch" href="/myblog/assets/js/page-树.24efdeaa.js"><link rel="prefetch" href="/myblog/assets/js/page-浏览器.bee9ec04.js"><link rel="prefetch" href="/myblog/assets/js/page-混合桌面应用开发.9e10d1c3.js"><link rel="prefetch" href="/myblog/assets/js/page-登录.bb830451.js"><link rel="prefetch" href="/myblog/assets/js/page-目录.c85b4d0b.js"><link rel="prefetch" href="/myblog/assets/js/page-移动端开发.56ac22ec.js"><link rel="prefetch" href="/myblog/assets/js/page-组件和组件封装.b5e86da2.js"><link rel="prefetch" href="/myblog/assets/js/page-计算机网络基础.0a106662.js"><link rel="prefetch" href="/myblog/assets/js/page-设计模式.ffdc7cfd.js"><link rel="prefetch" href="/myblog/assets/js/page-调试技巧.485ae36e.js"><link rel="prefetch" href="/myblog/assets/js/page-贪心算法.0f417640.js"><link rel="prefetch" href="/myblog/assets/js/page-输入url到页面展示全过程.510aef2e.js"><link rel="prefetch" href="/myblog/assets/js/page-递归.5e55e552.js"><link rel="prefetch" href="/myblog/assets/js/page-链表.1cf6927f.js"><link rel="prefetch" href="/myblog/assets/js/page-项目总结.ffcd2a4b.js"><link rel="prefetch" href="/myblog/assets/js/vendors~docsearch.f3877d0d.js"><link rel="prefetch" href="/myblog/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound~layout-components/Blog/BlogHome~layout-components/~5d377965.d9712593.js"><link rel="prefetch" href="/myblog/assets/js/vendors~layout-Blog~layout-Layout~layout-components/Blog/ArticleItem~layout-components/Blog/ArticleL~b56f3aac.47bb5cb5.js"><link rel="prefetch" href="/myblog/assets/js/vendors~layout-NotFound~layout-components/Common~layout-components/Page.57d58db9.js"><link rel="prefetch" href="/myblog/assets/js/vendors~layout-Slide.81546b3b.js"><link rel="prefetch" href="/myblog/assets/js/vendors~layout-components/AlgoliaSearch/Full.b30f067a.js"><link rel="prefetch" href="/myblog/assets/js/vendors~layout-components/Blog/BlogPage.bcccbd38.js"><link rel="prefetch" href="/myblog/assets/js/vendors~layout-components/Navbar/Navbar.e2a7361e.js"><link rel="prefetch" href="/myblog/assets/js/vendors~layout-components/Page.6c65077c.js"><link rel="prefetch" href="/myblog/assets/js/vendors~layout-components/Sidebar/Sidebar.34cd9cf7.js"><link rel="prefetch" href="/myblog/assets/js/vendors~photo-swipe.428df1da.js">
    <link rel="stylesheet" href="/myblog/assets/css/0.styles.645fbc6f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container has-navbar has-anchor"><header class="navbar"><!----> <div class="content__navbar-start"></div> <button title="Sidebar Button" class="sidebar-button"><span class="icon"></span></button> <a href="/myblog/" class="home-link router-link-active"><img src="./mylogo.png" alt="Sewen 博客" class="logo"> <!----> <span class="site-name can-hide">Sewen 博客</span></a> <!----> <div class="content__navbar-center"></div> <div class="links"><button tabindex="-1" aria-hidden="true" class="color-button"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="skin-icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4
        38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32
        51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0
        102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2
        6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4
        0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2
        9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224
        419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4
        470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0
        22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6
        12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128
        505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2
        16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8
        86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4
        80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6
        6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg> <div class="color-picker-menu" style="display:none;"><div class="theme-options"><ul class="themecolor-select"><label for="themecolor-select">Theme Color:</label> <li><span class="default-theme"></span></li> </ul> <div class="darkmode-toggle"><label for="darkmode-toggle" class="desc">Theme Mode:</label> <div class="darkmode-switch"><div class="item day"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon light-icon"><path d="M512 256a42.667 42.667 0 0 0 42.667-42.667V128a42.667 42.667 0 0 0-85.334 0v85.333A42.667 42.667 0 0 0 512 256zm384 213.333h-85.333a42.667 42.667 0 0 0 0 85.334H896a42.667 42.667 0 0 0 0-85.334zM256 512a42.667 42.667 0 0 0-42.667-42.667H128a42.667 42.667 0 0 0 0 85.334h85.333A42.667 42.667 0 0 0 256 512zm9.387-298.667a42.667 42.667 0 0 0-59.307 62.72l61.44 59.307a42.667 42.667 0 0 0 31.147 11.947 42.667 42.667 0 0 0 30.72-13.227 42.667 42.667 0 0 0 0-60.16zm459.946 133.974a42.667 42.667 0 0 0 29.44-11.947l61.44-59.307a42.667 42.667 0 0 0-57.6-62.72l-61.44 60.587a42.667 42.667 0 0 0 0 60.16 42.667 42.667 0 0 0 28.16 13.227zM512 768a42.667 42.667 0 0 0-42.667 42.667V896a42.667 42.667 0 0 0 85.334 0v-85.333A42.667 42.667 0 0 0 512 768zm244.48-79.36a42.667 42.667 0 0 0-59.307 61.44l61.44 60.587a42.667 42.667 0 0 0 29.44 11.946 42.667 42.667 0 0 0 30.72-12.8 42.667 42.667 0 0 0 0-60.586zm-488.96 0-61.44 59.307a42.667 42.667 0 0 0 0 60.586 42.667 42.667 0 0 0 30.72 12.8 42.667 42.667 0 0 0 28.587-10.666l61.44-59.307a42.667 42.667 0 0 0-59.307-61.44zM512 341.333A170.667 170.667 0 1 0 682.667 512 170.667 170.667 0 0 0 512 341.333z" fill="currentColor"></path></svg></div> <div class="item auto active"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon auto-icon"><path d="M460.864 539.072H564.8L510.592 376l-49.728 163.072zM872 362.368V149.504H659.648L510.528 0l-149.12 149.504H149.12v212.928L0 511.872l149.12 149.504v212.928h212.352l149.12 149.504 149.12-149.504h212.352V661.376l149.12-149.504L872 362.368zM614.464 693.12l-31.616-90.624H438.272l-31.616 90.624h-85.888l144.576-407.68h90.368l144.576 407.68h-85.824zm0 0" fill="currentColor"></path></svg></div> <div class="item night"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon dark-icon"><path d="M935.539 630.402c-11.43-11.432-28.674-14.739-43.531-8.354-46.734 20.103-96.363 30.297-147.508 30.297-99.59 0-193.221-38.784-263.64-109.203-108.637-108.637-139.61-270.022-78.908-411.148a39.497 39.497 0 0 0-51.886-51.887c-52.637 22.64-100.017 54.81-140.826 95.616-85.346 85.346-132.346 198.821-132.346 319.52 0 120.7 47.001 234.172 132.347 319.519S408.063 947.11 528.76 947.11c120.7 0 234.172-47.003 319.52-132.351 40.809-40.81 72.978-88.19 95.616-140.826a39.497 39.497 0 0 0-8.356-43.532z" fill="currentColor"></path></svg></div></div> <!----></div></div></div></button> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/myblog/" class="nav-link router-link-active"><!---->
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Front-end Basics" class="dropdown-title"><span class="title"><!---->
        前端基础
      </span> <span class="arrow"></span></button> <ul class="nav-dropdown"><li class="dropdown-item"><a href="/myblog/projectsSummary/html/" class="nav-link"><!---->
  HTML
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/css/" class="nav-link"><!---->
  Css
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/javascript/" class="nav-link"><!---->
  JavaScript
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/typescript/" class="nav-link"><!---->
  TypeScript
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><span class="title"><!---->
        计算机基础
      </span> <span class="arrow"></span></button> <ul class="nav-dropdown"><li class="dropdown-item"><a href="/myblog/projectsSummary/algorithms/" class="nav-link"><!---->
  数据结构和算法
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/network/" class="nav-link"><!---->
  计算机网络/HTTP
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/network/输入url到页面展示全过程/" class="nav-link"><!---->
  输入url到页面展示全过程
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/operating-system/" class="nav-link"><!---->
  操作系统
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/design-model/" class="nav-link"><!---->
  设计模式
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/Web-Security/" class="nav-link"><!---->
  Web安全
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架和源码分析" class="dropdown-title"><span class="title"><!---->
        框架和源码分析
      </span> <span class="arrow"></span></button> <ul class="nav-dropdown"><li class="dropdown-item"><a href="/myblog/projectsSummary/vue/Vue2原理和源码分析.html" class="nav-link"><!---->
  Vue 专题
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/React/" class="nav-link"><!---->
  React 专题
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/webpack/webpack构建原理.html" class="nav-link"><!---->
  webpack 专题
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/vite/" class="nav-link"><!---->
  vite 专题
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/axios/" class="nav-link"><!---->
  Axios 专题
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="浏览器" class="dropdown-title"><span class="title"><!---->
        浏览器
      </span> <span class="arrow"></span></button> <ul class="nav-dropdown"><li class="dropdown-item"><a href="/myblog/projectsSummary/browser/浏览器原理/" class="nav-link"><!---->
  浏览器原理
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/browser/前端缓存和存储/" class="nav-link"><!---->
  前端缓存和存储
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/performance/前端调试技巧/" class="nav-link"><!---->
  前端调试技巧
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="node.js" class="dropdown-title"><span class="title"><!---->
        服务器
      </span> <span class="arrow"></span></button> <ul class="nav-dropdown"><li class="dropdown-item"><a href="/myblog/projectsSummary/node/" class="nav-link"><!---->
  Node.js
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/linux/" class="nav-link"><!---->
  Linux
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/mysql/" class="nav-link"><!---->
  MySQL
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/nginx/" class="nav-link"><!---->
  Nginx
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/docker/" class="nav-link"><!---->
  Docker
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="浏览器和性能优化" class="dropdown-title"><span class="title"><!---->
        性能优化
      </span> <span class="arrow"></span></button> <ul class="nav-dropdown"><li class="dropdown-item"><a href="/myblog/projectsSummary/performance/性能优化指标和监控/" class="nav-link"><!---->
  性能优化指标和监控
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/performance/前端性能优化方案/" class="nav-link"><!---->
  前端性能优化方案
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/performance/一次管理后台的渲染优化/" class="nav-link"><!---->
  一次管理后台的渲染优化
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端工程" class="dropdown-title"><span class="title"><!---->
        前端工程
      </span> <span class="arrow"></span></button> <ul class="nav-dropdown"><li class="dropdown-item"><a href="/myblog/projectsSummary/Front-end-Engineering/前端工程化/" class="nav-link"><!---->
  前端工程化
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/Front-end-Engineering/前端渲染架构/" class="nav-link"><!---->
  前端渲染架构
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/Front-end-Engineering/前端架构实践/" class="nav-link"><!---->
  前端架构实践
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/Front-end-Engineering/npm/" class="nav-link"><!---->
  npm
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/git/" class="nav-link"><!---->
  Git
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/projectDeploy/自动构建和部署/" class="nav-link"><!---->
  自动构建和部署
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="项目实践" class="dropdown-title"><span class="title"><!---->
        项目实践
      </span> <span class="arrow"></span></button> <ul class="nav-dropdown"><li class="dropdown-item"><a href="/myblog/projectsSummary/projectDeploy/" class="nav-link"><!---->
  前端部署
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/componentsEncapsulation/组件和组件封装实践.html" class="nav-link"><!---->
  组件和组件封装实践
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/projectsSummary/登录与单点登录/" class="nav-link"><!---->
  登录与单点登录
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/projectsSummary/权限管理方案实践/" class="nav-link"><!---->
  权限管理方案实践
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/projectsSummary/Echarts二次封装实践/" class="nav-link"><!---->
  Echarts二次封装实践
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/projectsSummary/文档在线预览和编辑方案/" class="nav-link"><!---->
  文档在线预览和编辑方案
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/projectsSummary/移动端开发实践/" class="nav-link"><!---->
  移动端开发实践
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="项目搭建到原理分析" class="dropdown-title"><span class="title"><!---->
        项目搭建
      </span> <span class="arrow"></span></button> <ul class="nav-dropdown"><li class="dropdown-item"><a href="/myblog/projectsSummary/projectsSummary/从零到一搭建SSR项目/" class="nav-link"><!---->
  从零到一搭建SSR项目
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/projectsSummary/从零到一搭建移动端SSG项目/" class="nav-link"><!---->
  从零到一搭建移动端SSG项目
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/projectsSummary/移动端SSG项目实践/" class="nav-link"><!---->
  移动端SSG项目实践
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/projectsSummary/从零到一搭建Vue2工程化项目/" class="nav-link"><!---->
  从零到一搭建Vue2工程化项目
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/projectsSummary/从零到一搭建Vue3工程化项目/" class="nav-link"><!---->
  从零到一搭建Vue3工程化项目
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/projectsSummary/搭建低代码平台/" class="nav-link"><!---->
  搭建低代码平台
</a></li><li class="dropdown-item"><a href="/myblog/projectsSummary/projectsSummary/混合桌面应用开发实践/" class="nav-link"><!---->
  混合桌面应用开发实践
</a></li></ul></div></div></nav> <!----> <!----> <!----> <div class="content__navbar-end"></div></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><div vocab="https://schema.org/" typeof="Person" class="blogger-info mobile"><div data-balloon-pos="down" role="navigation" class="blogger hasIntro"><img property="image" alt="Blogger Avatar" src="./mylogo.png" class="avatar round"> <div property="name" class="name">Sewen 博客</div> <meta property="url" content="../outline.md"></div> <div class="num-wrapper"><div><div class="num">91</div> <div>Articles</div></div> <div><div class="num">0</div> <div>Category</div></div> <div><div class="num">0</div> <div>Tags</div></div> <div><div class="num">91</div> <div>Timeline</div></div></div> <div class="media-links-wrapper"><a href="https://github.com/Sewar-x/myblog" rel="noopener noreferrer" target="_blank" aria-label="Github" data-balloon-pos="up" class="media-link"><span class="sr-only">Github</span> <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon icon-github"><circle cx="512" cy="512" r="512" fill="#171515"></circle> <path d="M509.423 146.442c-200.317 0-362.756 162.42-362.756 362.8 0 160.266 103.936 296.24 248.109 344.217 18.139 3.327 24.76-7.872 24.76-17.486 0-8.613-.313-31.427-.49-61.702-100.912 21.923-122.205-48.63-122.205-48.63-16.495-41.91-40.28-53.067-40.28-53.067-32.937-22.51 2.492-22.053 2.492-22.053 36.407 2.566 55.568 37.386 55.568 37.386 32.362 55.438 84.907 39.43 105.58 30.143 3.296-23.444 12.667-39.43 23.032-48.498-80.557-9.156-165.246-40.28-165.246-179.297 0-39.604 14.135-71.988 37.342-97.348-3.731-9.178-16.18-46.063 3.556-96.009 0 0 30.46-9.754 99.76 37.19 28.937-8.048 59.97-12.071 90.823-12.211 30.807.14 61.843 4.165 90.822 12.21 69.26-46.944 99.663-37.189 99.663-37.189 19.792 49.946 7.34 86.831 3.61 96.01 23.25 25.359 37.29 57.742 37.29 97.347 0 139.366-84.82 170.033-165.637 179.013 13.026 11.2 24.628 33.342 24.628 67.182 0 48.498-.445 87.627-.445 99.521 0 9.702 6.535 20.988 24.945 17.444 144.03-48.067 247.881-183.95 247.881-344.175 0-200.378-162.442-362.798-362.802-362.798z" fill="#FFF"></path></svg></a><a href="1567910907" rel="noopener noreferrer" target="_blank" aria-label="Wechat" data-balloon-pos="up" class="media-link"><span class="sr-only">Wechat</span> <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon icon-wechat"><circle cx="512" cy="512" r="512" fill="#1AC88E"></circle> <path d="M827.551 578.742a176.583 176.583 0 0 0-185.685-158.379 172.942 172.942 0 0 0-186.3 158.379 172.942 172.942 0 0 0 185.686 158.379 282.169 282.169 0 0 0 65.536-10.923l60.689 32.768-16.384-54.613a166.275 166.275 0 0 0 76.458-125.611zm-245.76-27.307a21.845 21.845 0 1 1 0-43.69 24.872 24.872 0 0 1 27.307 21.845 24.872 24.872 0 0 1-27.921 21.845h.614zm121.356 0a21.845 21.845 0 1 1 0-43.69 24.872 24.872 0 0 1 27.306 21.845 24.872 24.872 0 0 1-28.512 21.845h1.206z" fill="#FFF"></path> <path d="M623.662 400.953h21.23A222.709 222.709 0 0 0 419.772 245.6a208.145 208.145 0 0 0-223.323 189.94 182.044 182.044 0 0 0 89.201 150.483l-22.436 67.356 78.279-39.435a389.575 389.575 0 0 0 78.279 10.923h20.616a163.226 163.226 0 0 1-6.667-46.718 182.044 182.044 0 0 1 189.94-177.197zm-121.379-60.69a27.921 27.921 0 1 1 0 55.843 31.562 31.562 0 0 1-33.36-27.921 31.562 31.562 0 0 1 34.59-27.921h-1.23zM346.34 396.107a31.562 31.562 0 0 1-33.383-27.921 31.562 31.562 0 0 1 33.383-27.921 27.921 27.921 0 1 1 0 55.842z" fill="#FFF"></path></svg></a></div></div> <hr> <!----> <div class="content__sidebar-top"></div> <nav class="sidebar-nav-links"><div class="nav-item"><a href="/myblog/" class="nav-link router-link-active"><!---->
  首页
</a></div><div class="nav-item"><div class="mobile-dropdown-wrapper"><button type="button" aria-label="Front-end Basics" class="dropdown-title"><span class="title"><!---->
      前端基础
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/html/" class="nav-link"><!---->
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/css/" class="nav-link"><!---->
  Css
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/javascript/" class="nav-link"><!---->
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/typescript/" class="nav-link"><!---->
  TypeScript
</a></li></ul></div></div><div class="nav-item"><div class="mobile-dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><span class="title"><!---->
      计算机基础
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/algorithms/" class="nav-link"><!---->
  数据结构和算法
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/network/" class="nav-link"><!---->
  计算机网络/HTTP
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/network/输入url到页面展示全过程/" class="nav-link"><!---->
  输入url到页面展示全过程
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/operating-system/" class="nav-link"><!---->
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/design-model/" class="nav-link"><!---->
  设计模式
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/Web-Security/" class="nav-link"><!---->
  Web安全
</a></li></ul></div></div><div class="nav-item"><div class="mobile-dropdown-wrapper"><button type="button" aria-label="框架和源码分析" class="dropdown-title"><span class="title"><!---->
      框架和源码分析
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/vue/Vue2原理和源码分析.html" class="nav-link"><!---->
  Vue 专题
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/React/" class="nav-link"><!---->
  React 专题
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/webpack/webpack构建原理.html" class="nav-link"><!---->
  webpack 专题
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/vite/" class="nav-link"><!---->
  vite 专题
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/axios/" class="nav-link"><!---->
  Axios 专题
</a></li></ul></div></div><div class="nav-item"><div class="mobile-dropdown-wrapper"><button type="button" aria-label="浏览器" class="dropdown-title"><span class="title"><!---->
      浏览器
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/browser/浏览器原理/" class="nav-link"><!---->
  浏览器原理
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/browser/前端缓存和存储/" class="nav-link"><!---->
  前端缓存和存储
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/performance/前端调试技巧/" class="nav-link"><!---->
  前端调试技巧
</a></li></ul></div></div><div class="nav-item"><div class="mobile-dropdown-wrapper"><button type="button" aria-label="node.js" class="dropdown-title"><span class="title"><!---->
      服务器
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/node/" class="nav-link"><!---->
  Node.js
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/linux/" class="nav-link"><!---->
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/mysql/" class="nav-link"><!---->
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/nginx/" class="nav-link"><!---->
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/docker/" class="nav-link"><!---->
  Docker
</a></li></ul></div></div><div class="nav-item"><div class="mobile-dropdown-wrapper"><button type="button" aria-label="浏览器和性能优化" class="dropdown-title"><span class="title"><!---->
      性能优化
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/performance/性能优化指标和监控/" class="nav-link"><!---->
  性能优化指标和监控
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/performance/前端性能优化方案/" class="nav-link"><!---->
  前端性能优化方案
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/performance/一次管理后台的渲染优化/" class="nav-link"><!---->
  一次管理后台的渲染优化
</a></li></ul></div></div><div class="nav-item"><div class="mobile-dropdown-wrapper"><button type="button" aria-label="前端工程" class="dropdown-title"><span class="title"><!---->
      前端工程
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/Front-end-Engineering/前端工程化/" class="nav-link"><!---->
  前端工程化
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/Front-end-Engineering/前端渲染架构/" class="nav-link"><!---->
  前端渲染架构
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/Front-end-Engineering/前端架构实践/" class="nav-link"><!---->
  前端架构实践
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/Front-end-Engineering/npm/" class="nav-link"><!---->
  npm
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/git/" class="nav-link"><!---->
  Git
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/projectDeploy/自动构建和部署/" class="nav-link"><!---->
  自动构建和部署
</a></li></ul></div></div><div class="nav-item"><div class="mobile-dropdown-wrapper"><button type="button" aria-label="项目实践" class="dropdown-title"><span class="title"><!---->
      项目实践
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/projectDeploy/" class="nav-link"><!---->
  前端部署
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/componentsEncapsulation/组件和组件封装实践.html" class="nav-link"><!---->
  组件和组件封装实践
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/projectsSummary/登录与单点登录/" class="nav-link"><!---->
  登录与单点登录
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/projectsSummary/权限管理方案实践/" class="nav-link"><!---->
  权限管理方案实践
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/projectsSummary/Echarts二次封装实践/" class="nav-link"><!---->
  Echarts二次封装实践
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/projectsSummary/文档在线预览和编辑方案/" class="nav-link"><!---->
  文档在线预览和编辑方案
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/projectsSummary/移动端开发实践/" class="nav-link"><!---->
  移动端开发实践
</a></li></ul></div></div><div class="nav-item"><div class="mobile-dropdown-wrapper"><button type="button" aria-label="项目搭建到原理分析" class="dropdown-title"><span class="title"><!---->
      项目搭建
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/projectsSummary/从零到一搭建SSR项目/" class="nav-link"><!---->
  从零到一搭建SSR项目
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/projectsSummary/从零到一搭建移动端SSG项目/" class="nav-link"><!---->
  从零到一搭建移动端SSG项目
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/projectsSummary/移动端SSG项目实践/" class="nav-link"><!---->
  移动端SSG项目实践
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/projectsSummary/从零到一搭建Vue2工程化项目/" class="nav-link"><!---->
  从零到一搭建Vue2工程化项目
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/projectsSummary/从零到一搭建Vue3工程化项目/" class="nav-link"><!---->
  从零到一搭建Vue3工程化项目
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/projectsSummary/搭建低代码平台/" class="nav-link"><!---->
  搭建低代码平台
</a></li><li class="dropdown-item"><!----> <a href="/myblog/projectsSummary/projectsSummary/混合桌面应用开发实践/" class="nav-link"><!---->
  混合桌面应用开发实践
</a></li></ul></div></div> <!----></nav> <!----> <div class="content__sidebar-center"></div> <!----> <!----> <div class="content__sidebar-bottom"></div> <!----></aside> <main class="page"><nav class="breadcrumb"><ol vocab="https://schema.org/" typeof="BreadcrumbList"><li property="itemListElement" typeof="ListItem"><a href="/myblog/projectsSummary/" property="item" typeof="WebPage" class="router-link-active"><!----> <span property="name">项目总结</span></a> <meta property="position" content="1"></li><li property="itemListElement" typeof="ListItem" class="is-active"><a href="/myblog/projectsSummary/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BASSR%E9%A1%B9%E7%9B%AE/" aria-current="page" property="item" typeof="WebPage" class="router-link-exact-active router-link-active"><!----> <span property="name">从零到一搭建SSR项目</span></a> <meta property="position" content="2"></li></ol></nav> <!----> <div class="content__page-top"></div> <div vocab="https://schema.org/" typeof="Article" class="page-title"><h1><!----> <span property="headline">从零到一搭建SSR项目</span></h1> <div class="page-info"><!----> <true-info defaultAuthor="" categoryPath="/category/$category/" tagPath="/tag/$tag/"></true-info><true-info defaultAuthor="" categoryPath="/category/$category/" tagPath="/tag/$tag/"></true-info><true-info defaultAuthor="" categoryPath="/category/$category/" tagPath="/tag/$tag/"></true-info><true-info defaultAuthor="" categoryPath="/category/$category/" tagPath="/tag/$tag/"></true-info><true-info defaultAuthor="" categoryPath="/category/$category/" tagPath="/tag/$tag/"></true-info><true-info defaultAuthor="" categoryPath="/category/$category/" tagPath="/tag/$tag/"></true-info><true-info defaultAuthor="" categoryPath="/category/$category/" tagPath="/tag/$tag/"></true-info></div> <!----> <hr></div> <div class="anchor-place-holder"><aside id="anchor"><div class="anchor-wrapper"><ul class="anchor-list"><li class="anchor"><a href="/myblog/projectsSummary/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BASSR%E9%A1%B9%E7%9B%AE/#ssr是什么" class="anchor-link heading2"><div>SSR是什么？</div></a></li><li class="anchor"><a href="/myblog/projectsSummary/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BASSR%E9%A1%B9%E7%9B%AE/#为什么要用-ssr" class="anchor-link heading2"><div>为什么要用 SSR？</div></a></li><li class="anchor"><a href="/myblog/projectsSummary/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BASSR%E9%A1%B9%E7%9B%AE/#前端渲染架构类型" class="anchor-link heading2"><div>前端渲染架构类型</div></a></li><li class="anchor"><a href="/myblog/projectsSummary/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BASSR%E9%A1%B9%E7%9B%AE/#同构应用原理" class="anchor-link heading2"><div>同构应用原理</div></a></li><li class="anchor"><a href="/myblog/projectsSummary/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BASSR%E9%A1%B9%E7%9B%AE/#组件基于-vnode-渲染" class="anchor-link heading3"><div>组件基于 VNode 渲染</div></a></li><li class="anchor"><a href="/myblog/projectsSummary/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BASSR%E9%A1%B9%E7%9B%AE/#vnode" class="anchor-link heading3"><div>VNode</div></a></li><li class="anchor"><a href="/myblog/projectsSummary/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BASSR%E9%A1%B9%E7%9B%AE/#ssr架构" class="anchor-link heading2"><div>SSR架构</div></a></li><li class="anchor"><a href="/myblog/projectsSummary/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BASSR%E9%A1%B9%E7%9B%AE/#项目源码" class="anchor-link heading2"><div>项目源码</div></a></li><li class="anchor"><a href="/myblog/projectsSummary/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BASSR%E9%A1%B9%E7%9B%AE/#源码分析" class="anchor-link heading2"><div>源码分析</div></a></li><li class="anchor"><a href="/myblog/projectsSummary/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BASSR%E9%A1%B9%E7%9B%AE/#项目目录" class="anchor-link heading3"><div>项目目录</div></a></li><li class="anchor"><a href="/myblog/projectsSummary/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BASSR%E9%A1%B9%E7%9B%AE/#app-js" class="anchor-link heading3"><div>app.js</div></a></li><li class="anchor"><a href="/myblog/projectsSummary/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BASSR%E9%A1%B9%E7%9B%AE/#entry-client-js" class="anchor-link heading3"><div>entry-client.js</div></a></li><li class="anchor"><a href="/myblog/projectsSummary/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BASSR%E9%A1%B9%E7%9B%AE/#entry-server-js" class="anchor-link heading3"><div>entry-server.js</div></a></li><li class="anchor"><a href="/myblog/projectsSummary/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BASSR%E9%A1%B9%E7%9B%AE/#server-js" class="anchor-link heading3"><div>server.js</div></a></li><li class="anchor"><a href="/myblog/projectsSummary/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BASSR%E9%A1%B9%E7%9B%AE/#编译流程" class="anchor-link heading2"><div>编译流程</div></a></li><li class="anchor"><a href="/myblog/projectsSummary/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BASSR%E9%A1%B9%E7%9B%AE/#webpack-构建" class="anchor-link heading2"><div>Webpack 构建</div></a></li><li class="anchor"><a href="/myblog/projectsSummary/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BASSR%E9%A1%B9%E7%9B%AE/#服务端构建流程" class="anchor-link heading3"><div>服务端构建流程</div></a></li><li class="anchor"><a href="/myblog/projectsSummary/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BASSR%E9%A1%B9%E7%9B%AE/#客户端构建流程" class="anchor-link heading3"><div>客户端构建流程</div></a></li><li class="anchor"><a href="/myblog/projectsSummary/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BASSR%E9%A1%B9%E7%9B%AE/#编译产物分析" class="anchor-link heading3"><div>编译产物分析</div></a></li><li class="anchor"><a href="/myblog/projectsSummary/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BASSR%E9%A1%B9%E7%9B%AE/#webpack-配置" class="anchor-link heading2"><div>Webpack 配置</div></a></li><li class="anchor"><a href="/myblog/projectsSummary/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BASSR%E9%A1%B9%E7%9B%AE/#webpack-base-config" class="anchor-link heading3"><div>`webpack.base.config`</div></a></li><li class="anchor"><a href="/myblog/projectsSummary/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BASSR%E9%A1%B9%E7%9B%AE/#webpack-server-config" class="anchor-link heading3"><div>`webpack.server.config`</div></a></li><li class="anchor"><a href="/myblog/projectsSummary/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BASSR%E9%A1%B9%E7%9B%AE/#webpack-client-config" class="anchor-link heading3"><div>`webpack.client.config`</div></a></li><li class="anchor"><a href="/myblog/projectsSummary/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BASSR%E9%A1%B9%E7%9B%AE/#setup-dev-server" class="anchor-link heading3"><div>`setup-dev-server`</div></a></li></ul></div></aside></div> <!----> <div class="content__content-top"></div> <div class="theme-default-content content__default"><h1 id="从零到一搭建ssr项目"><a href="#从零到一搭建ssr项目" class="header-anchor">#</a> 从零到一搭建SSR项目</h1> <h2 id="ssr是什么"><a href="#ssr是什么" class="header-anchor">#</a> <strong>SSR是什么</strong>？</h2> <p>Vue.js 是一个用于构建客户端应用的框架。</p> <p>默认情况下，Vue 组件的职责是在浏览器中生成和操作 DOM。</p> <p>然而，Vue 也支持将组件在服务端直接渲染成 HTML 字符串，作为服务端响应返回给浏览器，最后在浏览器端将静态的 HTML“激活”(hydrate) 为能够交互的客户端应用。</p> <p>一个由服务端渲染的 Vue.js 应用也可以被认为是“同构的”(Isomorphic) 或“通用的”(Universal)，因为应用的大部分代码同时运行在服务端和客户端。</p> <blockquote><p>基础知识参考官方文档<a href="https://cn.vuejs.org/guide/scaling-up/ssr.html" target="_blank" rel="noopener noreferrer">Vue SSR<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h2 id="为什么要用-ssr"><a href="#为什么要用-ssr" class="header-anchor">#</a> 为什么要用 SSR？</h2> <ul><li><p><strong>更好的 SEO</strong>：搜索引擎爬虫可以直接看到完全渲染的页面。</p> <ul><li>搜索引擎爬虫是不会等待异步请求数据结束后再抓取信息，SSR 技术在服务器端直接生成 HTML，这意味着爬虫可以直接获取完整的 HTML 页面，而无需等待 JavaScript 代码的执行。</li></ul></li> <li><p><strong>更快的首屏加载</strong>：</p> <ul><li>服务端渲染的 HTML 无需等到所有的 JavaScript 都下载并执行完成之后才显示，所以你的用户将会更快地看到完整渲染的页面。</li> <li>数据获取过程在首次访问时在服务端完成，相比于从客户端获取，可能有更快的数据库连接。</li> <li>这通常可以带来更高的<a href="https://web.dev/vitals/" target="_blank" rel="noopener noreferrer">核心 Web 指标<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>评分、更好的用户体验，而对于那些“首屏加载速度与转化率直接相关”的应用来说，这点可能至关重要。</li></ul></li></ul> <h2 id="前端渲染架构类型"><a href="#前端渲染架构类型" class="header-anchor">#</a> <strong>前端渲染架构类型</strong></h2> <p>前端架构演进方向： <strong>CSR 一&gt; SSR 一&gt; NSR 一&gt; ESR</strong></p> <p>具体参考博客：<a href="https://sewar-x.github.io/Front-end-Engineering/%E5%89%8D%E7%AB%AF%E6%B8%B2%E6%9F%93%E6%9E%B6%E6%9E%84/#%E5%A4%9A%E9%A1%B5%E9%9D%A2%E5%BA%94%E7%94%A8" target="_blank" rel="noopener noreferrer">前端渲染架构 | Sewen 博客 (sewar-x.github.io)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="同构应用原理"><a href="#同构应用原理" class="header-anchor">#</a> <strong>同构应用原理</strong></h2> <h3 id="组件基于-vnode-渲染"><a href="#组件基于-vnode-渲染" class="header-anchor">#</a> <strong>组件基于 VNode 渲染</strong></h3> <p>VNode 本身是 js 对象，<strong>兼容性极强</strong>，不依赖当前的执行的环境，从而可以在服务端渲染及原生渲染。虚拟 DOM 频繁修改，最后比较出真实 DOM 需要更改的地方，可以达到<strong>局部渲染</strong>的目的，<strong>减少性能损耗</strong>。</p> <h3 id="vnode"><a href="#vnode" class="header-anchor">#</a> <strong>VNode</strong></h3> <p>VNode是一个虚拟节点，是Virtual Node的缩写。在计算机科学中，VNode是用来描述DOM节点的一种数据结构。</p> <p>每个VNode对象代表了一个DOM节点，包含了节点的类型、属性、子节点等信息。</p> <p>在虚拟DOM（Virtual DOM）的概念中，VNode被用作在内存中表示真实DOM的一种方式。例如，当你在浏览器中创建一个新的HTML元素（如<code>&lt;div&gt;</code>）时，Vue.js实际上会为这个元素创建一个VNode对象。这个VNode对象就像是一个镜像，它包含了真实DOM元素的所有属性和方法。</p> <p><strong>示例</strong></p> <p>假设你有一个简单的HTML页面，其中包含一个<code>&lt;ul&gt;</code>元素和一个<code>&lt;li&gt;</code>元素：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>  
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>Item 1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>  
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>Item 2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>  
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在Vue.js中，当你将这个页面绑定到一个Vue实例时，Vue.js实际上会为每个<code>&lt;li&gt;</code>元素创建一个VNode对象。这些VNode对象将用作构建虚拟DOM的基础。当你想在列表中插入一个新的<code>&lt;li&gt;</code>元素时，Vue.js会在虚拟DOM中创建一个新的VNode对象，并将其插入到虚拟DOM树中。然后，Vue.js会将这个虚拟DOM树与真实DOM进行同步，从而更新页面上的元素。</p> <h2 id="ssr架构"><a href="#ssr架构" class="header-anchor">#</a> <strong>SSR架构</strong></h2> <blockquote><p>项目基于 Vue2 SSR 官文 demo 项目 <a href="https://github.com/vuejs/vue-hackernews-2.0/" target="_blank" rel="noopener noreferrer">HackerNews<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>  进行分析，在阅读之前建议先阅读 <a href="https://v2.ssr.vuejs.org/zh/#%E4%BB%80%E4%B9%88%E6%98%AF%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E6%B8%B2%E6%9F%93-ssr" target="_blank" rel="noopener noreferrer">Vue.js 服务器端渲染指南 | Vue SSR 指南 (vuejs.org)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p><img src="/myblog/assets/img/SSR架构.08daea42.png" alt="SSR架构"></p> <p>Vue SSR 框架为同构框架，应用代码编译过程 Vue SSR 提供了两个编译入口，服务端应用和客户端应用，作为抹平由于环境不同的代码差异；</p> <p>由于用例和平台 API 的差异，当运行在不同环境中时，代码将不会完全相同。</p> <p>对于客户端应用程序和服务器应用程序，我们都要使用 webpack 打包 - 服务器需要「服务器 bundle」然后用于服务器端渲染(SSR)，而「客户端 bundle」会发送给浏览器，用于混合静态标记。</p> <h2 id="项目源码"><a href="#项目源码" class="header-anchor">#</a> <strong>项目源码</strong></h2> <p>SSR 应用包含主要源码：</p> <ul><li>通用代码 <code>app.js</code>: 用于服务端渲染和客户端渲染的公共代码。包含应用通用代码、组件、Vuex、路由和页面等。</li> <li>服务端渲染 <code>Server entry</code>: 创建返回应用实例，同时还会进行路由匹配和数据的预处理，仅运行于服务器。</li> <li>客户端渲染 <code>Client entry</code>:  负责创建应用程序，挂载实例 DOM ，仅运行于浏览器。</li> <li>HTTP 服务 <code>Server.js</code>:  Node Server，用于接受请求编译服务端渲染的 HTTP 服务。</li></ul> <p><strong>通用代码特性</strong></p> <ul><li>通用代码不可接受特定平台的 API（因此如果你的代码中，直接使用了像 <code>window</code> 或 <code>document</code>，这种仅浏览器可用的全局变量，则会在 Node.js 中执行时抛出错误，反之也是如此）</li></ul> <p><strong>服务端渲染特性</strong></p> <ul><li>服务器端渲染中<strong>为每个请求创建一个新的根 Vue 实例</strong>，每个请求都是全新的、独立的应用程序实例，以便不会有交叉请求造成的状态污染；</li> <li>将数据进行响应式的过程在服务器上是多余的，所以默认情况下禁用；</li> <li>所有的生命周期钩子函数中，只有 <code>beforeCreate</code> 和 <code>created</code> 会在服务器端渲染 (SSR) 过程中被调用；
<ul><li>应该避免在 <code>beforeCreate</code> 和 <code>created</code> 生命周期时产生全局副作用的代码，例如在其中使用 <code>setInterval</code> 设置 timer。由于服务端渲染代码在 SSR 期间并不会调用销毁钩子函数，所以 timer 将永远保留下来。</li> <li>为了避免这种情况，请将副作用代码移动到 <code>beforeMount</code> 或 <code>mounted</code> 生命周期中。</li></ul></li></ul> <p><strong>客户端渲染特性</strong></p> <ul><li>任何生命周期钩子函数中的代码（例如 <code>beforeMount</code> 或 <code>mounted</code>），都会在客户端执行。</li> <li>对于仅浏览器可用的 API，通常方式是，在「纯客户端 (client-only)」的生命周期钩子函数中惰性访问 (lazily access) 它们。</li></ul> <h2 id="源码分析"><a href="#源码分析" class="header-anchor">#</a> <strong>源码分析</strong></h2> <blockquote><p>项目基于 Vue2 SSR 官文 demo 项目 <a href="https://github.com/vuejs/vue-hackernews-2.0/" target="_blank" rel="noopener noreferrer">HackerNews<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>  进行分析</p></blockquote> <h3 id="项目目录"><a href="#项目目录" class="header-anchor">#</a> <strong>项目目录</strong></h3> <p><img src="/myblog/assets/img/vuessr项目目录.73605dc1.png" alt="image-20240204153420534"></p> <h3 id="app-js"><a href="#app-js" class="header-anchor">#</a> <code>app.js</code></h3> <p><code>app.js</code> 是我们应用程序的「通用 entry」。</p> <p>在纯客户端应用程序中，我们将在此文件中创建根 Vue 实例，并直接挂载到 DOM。</p> <p>在服务器端渲染(SSR)，为每个请求创建一个新的根 Vue 实例，避免请求状态交叉污染。</p> <p><code>app.js</code> 简单地使用 export 导出一个 <code>createApp</code> 函数,该函数在每次调用时创建一个新的 store, router, app实例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App.vue'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./store'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./router'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> sync <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vuex-router-sync'</span>
<span class="token keyword">import</span> titleMixin <span class="token keyword">from</span> <span class="token string">'./util/title'</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> filters <span class="token keyword">from</span> <span class="token string">'./util/filters'</span>

<span class="token comment">// 标题 mixin</span>
Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span>titleMixin<span class="token punctuation">)</span>

<span class="token comment">// 注册全局 utility 过滤器</span>
Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>filters<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  Vue<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> filters<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// Node.js 服务器是一个长期运行的进程。当我们的代码进入该进程时，它将进行一次取值并留存在内存中。这意味着如果创建一个单例对象，它将在每个传入的请求之间共享</span>
<span class="token comment">// 为每个请求创建一个新的根 Vue 实例,避免请求状态交叉污染。暴露一个工厂函数，该函数在每次调用时创建一个新的 store, router, app实例</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">createRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">// 同步路由和 Vuex 状态，注册 store.state.route</span>
  <span class="token function">sync</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> router<span class="token punctuation">)</span>

  <span class="token comment">// create the app instance.</span>
  <span class="token comment">// here we inject the router, store and ssr context to all child components,</span>
  <span class="token comment">// making them available everywhere as `this.$router` and `this.$store`.</span>
  <span class="token comment">// 创建 app 实例,此处注入 router 和 store 和 ssr 上下文到所有子组件,在 vue 实例任何地方可以通过 this.$router 和 this.$store 获取路由和状态对象</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    router<span class="token punctuation">,</span>
    store<span class="token punctuation">,</span>
    <span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token parameter">h</span> <span class="token operator">=&gt;</span> <span class="token function">h</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  
  <span class="token comment">//对外暴露 app,  router 和  store</span>
  <span class="token comment">// 请注意，我们不在这里挂载应用程序，在浏览器还是在服务器上初始化流程不同</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> router<span class="token punctuation">,</span> store <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><h3 id="entry-client-js"><a href="#entry-client-js" class="header-anchor">#</a> <code>entry-client.js</code></h3> <p>客户端 entry 只需创建应用程序，并且将其挂载到 DOM 中 ，仅运行于浏览器</p> <p>使用 WebPack 构建后的「客户端 bundle」会发送给浏览器，用于混合静态标记。</p> <p>客户端 entry 核心代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app'</span>

<span class="token comment">// 客户端特定引导逻辑……</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> app <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 这里假定 App.vue 模板中根元素具有 `id=&quot;app&quot;`</span>
app<span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>完整代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> <span class="token string">'es6-promise/auto'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app'</span>
<span class="token keyword">import</span> ProgressBar <span class="token keyword">from</span> <span class="token string">'./components/ProgressBar.vue'</span>

<span class="token comment">// 全局进度条</span>
<span class="token keyword">const</span> bar <span class="token operator">=</span> <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$bar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span>ProgressBar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>bar<span class="token punctuation">.</span>$el<span class="token punctuation">)</span>

<span class="token comment">// 全局 mixin：当组件参数发生变化时，调用组件内的 asyncData，用于预获取路由页面客户端渲染数据 </span>
<span class="token comment">// 此函数会在组件实例化之前调用，所以它无法访问 this</span>
Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">beforeRouteUpdate</span> <span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> from<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> asyncData <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options
    <span class="token keyword">if</span> <span class="token punctuation">(</span>asyncData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">asyncData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">store</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">,</span>
        <span class="token literal-property property">route</span><span class="token operator">:</span> to
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">//匹配要渲染的视图后，再获取数据,当路由导航被触发时，可以立即切换视图，因此应用程序具有更快的响应速度</span>
<span class="token comment">// Vue.mixin({</span>
<span class="token comment">//   beforeMount () {</span>
<span class="token comment">//     const { asyncData } = this.$options</span>
<span class="token comment">//     if (asyncData) {</span>
<span class="token comment">//       // 将获取数据操作分配给 promise</span>
<span class="token comment">//       // 以便在组件中，我们可以在数据准备就绪后</span>
<span class="token comment">//       // 通过运行 `this.dataPromise.then(...)` 来执行其他任务</span>
<span class="token comment">//       this.dataPromise = asyncData({</span>
<span class="token comment">//         store: this.$store,</span>
<span class="token comment">//         route: this.$route</span>
<span class="token comment">//       })</span>
<span class="token comment">//     }</span>
<span class="token comment">//   }</span>
<span class="token comment">// })</span>

<span class="token comment">// 获取 app、router 和 store 实例</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> router<span class="token punctuation">,</span> store <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 当使用 template 时，context.state 将作为 window.__INITIAL_STATE__ 状态，自动嵌入到最终的 HTML 中</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>__INITIAL_STATE__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  store<span class="token punctuation">.</span><span class="token function">replaceState</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>__INITIAL_STATE__<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 等到路由器在钩子和异步组件之前解析了所有的异步</span>
router<span class="token punctuation">.</span><span class="token function">onReady</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 添加路由钩子函数，用于处理 asyncData.</span>
  <span class="token comment">// 在初始路由 resolve 后执行，以便我们不会二次预取(double-fetch)已有的数据。</span>
  <span class="token comment">// 使用 `router.beforeResolve()`，以便确保所有异步组件都 resolve。</span>
  router<span class="token punctuation">.</span><span class="token function">beforeResolve</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> from<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取路由匹配的进入和离开的异步组件</span>
    <span class="token keyword">const</span> matched <span class="token operator">=</span> router<span class="token punctuation">.</span><span class="token function">getMatchedComponents</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
    <span class="token keyword">const</span> prevMatched <span class="token operator">=</span> router<span class="token punctuation">.</span><span class="token function">getMatchedComponents</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span>
    <span class="token comment">// 我们只关心非预渲染的组件， 所以我们对比它们，找出两个匹配列表的差异组件</span>
    <span class="token keyword">let</span> diffed <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token comment">// 比较进入和离开组件是否相同</span>
    <span class="token keyword">const</span> activated <span class="token operator">=</span> matched<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">c<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> diffed <span class="token operator">||</span> <span class="token punctuation">(</span>diffed <span class="token operator">=</span> <span class="token punctuation">(</span>prevMatched<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!==</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 过滤获取激活组件异步获取数据钩子</span>
    <span class="token keyword">const</span> asyncDataHooks <span class="token operator">=</span> activated<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=&gt;</span> c<span class="token punctuation">.</span>asyncData<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">_</span> <span class="token operator">=&gt;</span> _<span class="token punctuation">)</span>
    <span class="token comment">// 不存在获取数据钩子，直接进入导航页面</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>asyncDataHooks<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    bar<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//根据 asyncData 获取数据</span>
    Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>asyncDataHooks<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">hook</span> <span class="token operator">=&gt;</span> <span class="token function">hook</span><span class="token punctuation">(</span><span class="token punctuation">{</span> store<span class="token punctuation">,</span> <span class="token literal-property property">route</span><span class="token operator">:</span> to <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        bar<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">//挂载 dom </span>
  app<span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// service worker</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'https:'</span> <span class="token operator">===</span> location<span class="token punctuation">.</span>protocol <span class="token operator">&amp;&amp;</span> navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'/service-worker.js'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br></div></div><blockquote><p>客户端渲染主要逻辑：</p> <ol><li>获取 app、router 和 store 实例；</li> <li>获取 <code>window.__INITIAL_STATE__</code> 状态，注入到store 中；（<code>window.__INITIAL_STATE__</code> 是通过服务端渲染预先获取的数据，并注入在 HTML 页面中的 <code>window.__INITIAL_STATE__</code>  变量中）；</li> <li>全局 mixin：在客户端激活后，当组件参数发生变化时，调用组件内的 asyncData 钩子，用于预获取路由页面客户端渲染的数据；</li> <li>挂载 dom ；</li> <li>监听路由变化，当路由变化时：
<ul><li>获取路由匹配的进入和离开的异步组件；</li> <li>比较进入和离开组件是否相同；</li> <li>过滤获取激活组件获取数据 asyncData  钩子；</li> <li>根据 asyncData 获取数据；</li></ul></li> <li>进入路由页面，客户端渲染页面。</li></ol></blockquote> <h3 id="entry-server-js"><a href="#entry-server-js" class="header-anchor">#</a> <code>entry-server.js</code></h3> <p>创建返回应用实例，同时还会进行路由匹配和数据的预处理，仅运行于服务器。</p> <p>服务端 entry 核心代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token parameter">context</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> app <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> app
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>完整代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app'</span>

<span class="token keyword">const</span> isDev <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span>

<span class="token comment">// 暴露一个方法用于 bundleRenderer 调用。在服务端渲染时主要执行数据预取，定义应用状态。</span>
<span class="token comment">// 一旦数据完成同步，该方法将返回一个 Promise app 实例。</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token parameter">context</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> s <span class="token operator">=</span> isDev <span class="token operator">&amp;&amp;</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 记录请求时间</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> router<span class="token punctuation">,</span> store <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 每次请求获取新的 app 、 router、 store  对象</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> url <span class="token punctuation">}</span> <span class="token operator">=</span> context <span class="token comment">// 请求 url</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> fullPath <span class="token punctuation">}</span> <span class="token operator">=</span> router<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span>route <span class="token comment">// 解析 url 获取路由路径</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>fullPath <span class="token operator">!==</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">url</span><span class="token operator">:</span> fullPath <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 设置服务器端 router 的位置</span>
    router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>

    <span class="token comment">// 等到 router 将可能的异步组件和钩子函数解析完</span>
    router<span class="token punctuation">.</span><span class="token function">onReady</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 获取路由匹配的组件</span>
      <span class="token keyword">const</span> matchedComponents <span class="token operator">=</span> router<span class="token punctuation">.</span><span class="token function">getMatchedComponents</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// 没有匹配的组件，返回 404</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>matchedComponents<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">404</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
 
      <span class="token comment">// 调用路由匹配到的组件的 asyncData 钩子，asyncData 钩子分发 store action，当异步动作完成并 store 同步状态完成则返回 Promise。</span>
      Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>matchedComponents<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> asyncData <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> asyncData <span class="token operator">&amp;&amp;</span> <span class="token function">asyncData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        store<span class="token punctuation">,</span>
        <span class="token literal-property property">route</span><span class="token operator">:</span> router<span class="token punctuation">.</span>currentRoute
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 开发环境下控制台输出获取数据时间</span>
        isDev <span class="token operator">&amp;&amp;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">data pre-fetch: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> s<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token comment">// 在所有预取钩子(preFetch hook) resolve 后，我们的 store 现在已经填充入渲染应用程序所需的状态。</span>
        <span class="token comment">// 当我们将状态附加到上下文， 并且 `template` 选项用于 renderer 时，</span>
        <span class="token comment">// 状态将自动序列化为 `window.__INITIAL_STATE__`，并注入 HTML。</span>
        context<span class="token punctuation">.</span>state <span class="token operator">=</span> store<span class="token punctuation">.</span>state
        <span class="token function">resolve</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>reject<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><blockquote><p>服务端渲染过程主要执行逻辑：</p> <ol><li>解析 url 获取路由路径；</li> <li>获取路由匹配的组件；</li> <li>调用路由匹配到的组件的 asyncData 钩子预先获取组件数据；</li> <li>获取异步数据后，将数据填入 store，并自动序列化为 <code>window.__INITIAL_STATE__</code>，注入到 HTML。</li></ol></blockquote> <h3 id="server-js"><a href="#server-js" class="header-anchor">#</a> <code>server.js</code></h3> <p>Node Server，用于接受请求进行服务端渲染的 HTTP 服务。</p> <p>该服务接受 HTTP 请求，并根据请求 URL  匹配路由组件，获取数据并使用 <code>vue-server-renderer</code> 创建一个服务器端Vue组件渲染器，渲染静态 HTML 页面返回客户端。</p> <p>完整代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token comment">//文件操作</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token comment">//处理文件路径</span>
<span class="token keyword">const</span> <span class="token constant">LRU</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'lru-cache'</span><span class="token punctuation">)</span><span class="token comment">//缓存机制</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> favicon <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'serve-favicon'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> compression <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'compression'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> microcache <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'route-cache'</span><span class="token punctuation">)</span><span class="token comment">//缓存路由响应</span>
<span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token parameter">file</span> <span class="token operator">=&gt;</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> file<span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> createBundleRenderer <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-server-renderer'</span><span class="token punctuation">)</span><span class="token comment">//创建一个服务器端Vue组件渲染器</span>

<span class="token keyword">const</span> isProd <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span>
<span class="token keyword">const</span> useMicroCache <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MICRO_CACHE</span> <span class="token operator">!==</span> <span class="token string">'false'</span>
<span class="token keyword">const</span> serverInfo <span class="token operator">=</span>
  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">express/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express/package.json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">vue-server-renderer/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-server-renderer/package.json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">/**
 * 创建一个服务器端渲染器（server-side rendering
 * @param {*} bundle 一个已经预先编译好的服务器端 Vue.js 应用程序,这个应用程序已经被打包成一系列的模块，并且可能已经过优化。
 * @param {*} options 
 * @returns 
 */</span>
<span class="token keyword">function</span> <span class="token function">createRenderer</span> <span class="token punctuation">(</span><span class="token parameter">bundle<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// https://github.com/vuejs/vue/blob/dev/packages/vue-server-renderer/README.md#why-use-bundlerenderer</span>
  <span class="token comment">//通过使用 webpack 的自定义插件，server bundle 将生成为可传递到 bundle renderer 的特殊 JSON 文件</span>
  <span class="token keyword">return</span> <span class="token function">createBundleRenderer</span><span class="token punctuation">(</span>bundle<span class="token punctuation">,</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment">// LRU 为最近最近未使用缓存，用于组件缓存</span>
    <span class="token literal-property property">cache</span><span class="token operator">:</span> <span class="token constant">LRU</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">max</span><span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>
      <span class="token literal-property property">maxAge</span><span class="token operator">:</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">15</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">//只有当 vue-server-renderer 与 npm 链接时才需要这样做</span>
    <span class="token literal-property property">basedir</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'./dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">/**recommended for performance
     * true: 新上下文模式。创建新上下文并重新评估捆绑包在每个渲染上。确保每个应用程序的整个应用程序状态都是新的渲染，但会产生额外的评估成本。
     * false:直接模式。每次渲染时，它只调用导出的函数。而不是在上重新评估整个捆绑包模块评估成本较高，但需要结构化源代码
     * once: 初始上下文模式。 仅用于收集可能的非组件vue样式加载程序注入的样式。
    */</span>
    <span class="token literal-property property">runInNewContext</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    clientManifest <span class="token comment">// （可选）客户端构建 manifest</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> renderer
<span class="token keyword">let</span> readyPromise
<span class="token comment">// 渲染模板</span>
<span class="token keyword">const</span> templatePath <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'./src/index.template.html'</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>isProd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// In production: create server renderer using template and built server bundle.</span>
  <span class="token comment">// The server bundle is generated by vue-ssr-webpack-plugin.</span>
  <span class="token keyword">const</span> template <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>templatePath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
  <span class="token comment">// 一个已经预先编译好的服务器端 Vue.js 应用程序,这个应用程序已经被打包成一系列的模块，并且可能已经过优化。</span>
  <span class="token keyword">const</span> bundle <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./dist/vue-ssr-server-bundle.json'</span><span class="token punctuation">)</span>
  <span class="token comment">// 客户端清单,可选。它允许呈现程序自动推断预加载/预取链接，并直接为渲染期间使用的任何异步块添加 &lt; script &gt; 标记，从而避免了瀑布式请求。</span>
  <span class="token keyword">const</span> clientManifest <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./dist/vue-ssr-client-manifest.json'</span><span class="token punctuation">)</span>
  renderer <span class="token operator">=</span> <span class="token function">createRenderer</span><span class="token punctuation">(</span>bundle<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    template<span class="token punctuation">,</span>
    clientManifest
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// 在开发中: 使用 watch 和 hot-reload 设置 dev 服务器，并在 bundle 索引模板更新上创建一个新的渲染服务。</span>
  readyPromise <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./build/setup-dev-server'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>
    app<span class="token punctuation">,</span>
    templatePath<span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token parameter">bundle<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      renderer <span class="token operator">=</span> <span class="token function">createRenderer</span><span class="token punctuation">(</span>bundle<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 设置Express服务器静态文件缓存的函数</span>
<span class="token keyword">const</span> <span class="token function-variable function">serve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> cache</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token function">resolve</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">maxAge</span><span class="token operator">:</span> cache <span class="token operator">&amp;&amp;</span> isProd <span class="token operator">?</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">30</span> <span class="token operator">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">compression</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">threshold</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//使用compression中间件：这个中间件用于压缩响应数据，以便在网络传输中减少传输大小。通过这个中间件，客户端可以更快地接收和加载应用程序的内容。</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">favicon</span><span class="token punctuation">(</span><span class="token string">'./public/logo-48.png'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//使用favicon中间件：这个中间件用于设置网页图标，即在浏览器地址栏中的那个小图标</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/dist'</span><span class="token punctuation">,</span> <span class="token function">serve</span><span class="token punctuation">(</span><span class="token string">'./dist'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//使用serve中间件,提供静态资源</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/public'</span><span class="token punctuation">,</span> <span class="token function">serve</span><span class="token punctuation">(</span><span class="token string">'./public'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/manifest.json'</span><span class="token punctuation">,</span> <span class="token function">serve</span><span class="token punctuation">(</span><span class="token string">'./manifest.json'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/service-worker.js'</span><span class="token punctuation">,</span> <span class="token function">serve</span><span class="token punctuation">(</span><span class="token string">'./dist/service-worker.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// https://www.nginx.com/blog/benefits-of-microcaching-nginx/</span>
<span class="token comment">// 实现逻辑为，检查请求是否是用户特定(user-specific)。 只有非用户特定 (non-user-specific) 页面才会缓存。1秒微缓存</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>microcache<span class="token punctuation">.</span><span class="token function">cacheSeconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token parameter">req</span> <span class="token operator">=&gt;</span> useMicroCache <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>originalUrl<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">render</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> s <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//记录请求开始时间</span>
  res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;text/html&quot;</span><span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Server&quot;</span><span class="token punctuation">,</span> serverInfo<span class="token punctuation">)</span>
  <span class="token comment">// 错误处理对象</span>
  <span class="token keyword">const</span> <span class="token function-variable function">handleError</span> <span class="token operator">=</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">.</span>url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token number">404</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'404 | Page Not Found'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Render Error Page or Redirect</span>
      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'500 | Internal Server Error'</span><span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">error during render : </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>stack<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 渲染上下文对象,提供插值数据</span>
  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'Vue HN 2.0'</span><span class="token punctuation">,</span> <span class="token comment">// default title</span>
    <span class="token literal-property property">url</span><span class="token operator">:</span> req<span class="token punctuation">.</span>url
  <span class="token punctuation">}</span>
  renderer<span class="token punctuation">.</span><span class="token function">renderToString</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> html</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">handleError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isProd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">whole request: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> s<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">,</span> isProd <span class="token operator">?</span> <span class="token function-variable function">render</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  readyPromise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">render</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> port <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">8080</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">server started at localhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br></div></div><blockquote><p>Node HTTP 服务主要逻辑：</p> <ol><li>实例化 HTTP 服务，初始化服务中间件；</li> <li>根据运行环境（开发或生产），使用<code>vue-server-renderer</code>创建一个服务器端渲染器：
<ul><li>在生产环境中：通过 webpack 预先构建以上服务端渲染代码生成名称为 <code>vue-ssr-server-bundle.json</code> 的服务端渲染 Bundle，通过 webpack 预先构建以上客户端代码生成名为 <code>vue-ssr-client-manifest.json</code> 的客户端清单代码，再获取 HTML 渲染模板，将以上三个参数通过 <code>vue-server-renderer</code> 创建一个服务器端渲染器。</li> <li>在开发环境中：使用 <code>setup-dev-server</code> 启动一个本地开发服务，使用 watch 和 hot-reload 设置 dev 服务器，并在 bundle 索引模板更新上创建一个新的渲染服务。</li></ul></li> <li>并启动 HTTP 服务，监听请求；</li> <li>当请求到达服务后，通过渲染器的 <code>renderer.renderToString</code> 方法，将匹配到的组件渲染成 HTML 页面返回客户端。</li></ol></blockquote> <h2 id="编译流程"><a href="#编译流程" class="header-anchor">#</a> <strong>编译流程</strong></h2> <p>参考SSR 架构一节的架构图，<strong>SSR 渲染流程如下</strong>：</p> <ol><li>使用 Webpack 构建服务端渲染和客户端渲染代码，生成 <code>Server Bundle</code> 、 <code>Client Bundle</code> 和 HTML 页面；</li> <li>启动一个 Node HTTP  服务，监听请求；</li> <li>服务端 <code>Server Bundle</code>  运行在 Node HTTP  服务中；</li> <li>首次请求，将客户端 <code>Client Bundle</code> 和 HTML 页面发送到客户端；</li> <li>二次请求， Node HTTP  服务解析 URL 匹配组件，获取异步数据，注入到 Store 和 HTML 页面中的 <code>window.__INITIAL_STATE__</code> 变量中，渲染 HTML 页面；</li> <li>将渲染的 HTML 页面返回客户端；</li> <li>客户端接受到 HTML 页面后，进行客户端激活，客户端监听路由，异步获取数据，并解析 <code>window.__INITIAL_STATE__</code> 变量，再次渲染 HTML 页面；</li></ol> <p><img src="/myblog/assets/img/ssr过程.e63a48fe.png" alt=""></p> <blockquote><p>渲染流程：服务端渲染的主要流程是在服务器端生成完整的HTML页面，并将其发送给浏览器展示。</p> <ol><li>客户端请求：用户在浏览器中输入网址或点击链接，发送请求到服务器。</li> <li>服务器接收请求：服务器接收到客户端的请求，并进行处理。</li> <li>数据获取：服务器根据请求的内容，可能需要从数据库、API接口或其他数据源获取所需的数据。</li> <li>模板渲染：服务器使用事先定义好的模板引擎或渲染框架，将数据注入到模板中，生成完整的HTML页面。
<ul><li>在不同页面之间导航需要下载新的HTML，首页会从缓存中获取已渲染页面，为查找到则服务端重新渲染。</li></ul></li> <li>生成响应：服务器将渲染好的HTML页面作为响应的一部分，包括设置相应的HTTP状态码和头部信息。</li> <li>响应发送：服务器将生成的响应发送回客户端，通过网络传输到浏览器。</li> <li>客户端激活：浏览器接收到服务器发送的响应后，解析HTML并呈现页面内容。
<ul><li>客户端所需要做的仅仅是html页面的展现和之后的DOM事件处理。</li></ul></li> <li>客户端交互：浏览器加载完初始页面后，可以执行JavaScript代码，处理用户交互、数据请求和动态更新等操作。</li></ol></blockquote> <h2 id="webpack-构建"><a href="#webpack-构建" class="header-anchor">#</a> <strong>Webpack 构建</strong></h2> <p>以上渲染流程中，设计客户端和服务端代码的 Webpack 编译过程:</p> <h3 id="服务端构建流程"><a href="#服务端构建流程" class="header-anchor">#</a> <strong>服务端构建流程</strong></h3> <ul><li><p>通过 Wepack 构建 通用代码 <code>app.js</code> + 服务端渲染代码 <code>server-entry.js</code> + 渲染模板 = <code>Server Bundle</code>;</p></li> <li><p><code>Server Bundle</code> 运行在 <code>Node Server</code>。</p></li> <li><p>服务端启动一个 Node HTTP 服务监听请求，请求将客户端 <code>Client Bundle</code> 和 HTML 页面发送到客户端。</p></li></ul> <p><strong>渲染时机：</strong></p> <ul><li>通过 Express 服务渲染：浏览器输入 url 直接定向到某个页面，Express  执行 <code>entry-server.js</code> 动态渲染 HTML；</li></ul> <p><strong>总体流程：</strong></p> <ul><li>浏览器输入 <code>url -&gt; Express 服务接受请求 -&gt; 服务端获取数据 -&gt; 数据注入 store -&gt; SSR Renderer 渲染HTML页面 -&gt; 返回浏览器</code></li></ul> <h3 id="客户端构建流程"><a href="#客户端构建流程" class="header-anchor">#</a> <strong>客户端构建流程</strong></h3> <ul><li>通过 Wepack 构建 通用代码 <code>app.js</code> + 客户端端渲染代码 <code>client-entry.js</code> + 渲染模板 = <code>Client Bundle</code>;</li> <li>客户端激活：浏览器中 <code>Client Bundle</code> + 服务端数据<code>window.__INITIAL_STATE__</code> 变量 + HTML 静态页面。</li></ul> <p><strong>总体流程：</strong></p> <ul><li>首次渲染：由服务端渲染输出 HTML 页面发送到浏览器，客户端激活后通过路由导航的页面再次通过客户端渲染。（客户端激活：指的是 Vue 在浏览器端接管由服务端发送的静态 HTML，使其变为由 Vue 管理的动态 DOM 的过程。）</li> <li>二次渲染（客户端渲染）：页面内点击链接 -&gt; 客户端获取数据 -&gt; 浏览器渲染页面。</li></ul> <h3 id="编译产物分析"><a href="#编译产物分析" class="header-anchor">#</a> <strong>编译产物分析</strong></h3> <p>经过 webpack 打包之后会有两个 bundle 产物：<code>Server Bundle</code> 和 <code>Client Bundle</code>。</p> <ol><li><code>Server Bundle</code> 用于生成 <code>vue-ssr-server-bundle.json</code>， sourceMap 和需要在服务端运行的代码列表都在这个产物中。</li></ol> <p><code>vue-ssr-server-bundle.json</code> 简化代码如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span> 
  <span class="token string-property property">&quot;entry&quot;</span><span class="token operator">:</span> <span class="token punctuation">,</span> 
  <span class="token string-property property">&quot;files&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token constant">A</span>：包含了所有要在服务端运行的代码列表
    <span class="token constant">B</span>：入口文件
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><img src="/myblog/assets/img/vue-ssr-server-bundle.117a1d3d.png" alt="image-20240205111853861"></p> <ol start="2"><li><code>Client Bundle</code> 用于生成<code>vue-SSR-client-manifest.json</code>:包含所有的静态资源，首次渲染需要加载的 script 标签，以及需要在客户端运行的代码。</li></ol> <p><code>vue-SSR-client-manifest.json</code>简化代码如下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span> 
  <span class="token string-property property">&quot;publicPath&quot;</span><span class="token operator">:</span> 公共资源路径文件地址<span class="token punctuation">,</span> 
  <span class="token string-property property">&quot;all&quot;</span><span class="token operator">:</span> 资源列表
  <span class="token string-property property">&quot;initial&quot;</span><span class="token operator">:</span>输出 html 字符串
  <span class="token string-property property">&quot;async&quot;</span><span class="token operator">:</span> 异步加载组件集合
  <span class="token string-property property">&quot;modules&quot;</span><span class="token operator">:</span> moduleIdentifier 和 all 数组中文件的映射关系
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><img src="/myblog/assets/img/vue-SSR-client-manifest.838986ff.png" alt="image-20240205112213422"></p> <h2 id="webpack-配置"><a href="#webpack-配置" class="header-anchor">#</a> <strong>Webpack 配置</strong></h2> <p>通过以上 Webpack 构建分析可知，webpack 需要构建两部分代码：客户端渲染和服务端渲染代码，并且在服务端中，分为开发环境和生产环境，开发环境下使用 <code>webpack-hot-middleware</code> 启动一个本地 HTTP 服务。</p> <p>Webpack 构建配置目录如下：</p> <p><img src="/myblog/assets/img/vue-ssr-webpack配置.6ecc28b9.png" alt="image-20240205114152151"></p> <h3 id="webpack-base-config"><a href="#webpack-base-config" class="header-anchor">#</a> <strong><code>webpack.base.config</code></strong></h3> <p><code>webpack.base.config</code> 配置为服务端渲染和客户端渲染的基本配置，基本配置 (base config) 包含在两个环境共享的配置，例如，输出路径 (output path)，别名 (alias) 和 loader</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> ExtractTextPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'extract-text-webpack-plugin'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> FriendlyErrorsPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'friendly-errors-webpack-plugin'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> VueLoaderPlugin <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-loader'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> isProd <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// 是否开启source map，开发模式下开启，生产模式下关闭</span>
  <span class="token literal-property property">devtool</span><span class="token operator">:</span> isProd
    <span class="token operator">?</span> <span class="token boolean">false</span>
    <span class="token operator">:</span> <span class="token string">'#cheap-module-source-map'</span><span class="token punctuation">,</span>
  <span class="token comment">// 输出文件的位置</span>
  <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">path</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">publicPath</span><span class="token operator">:</span> <span class="token string">'/dist/'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'[name].[chunkhash].js'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 解析模块的别名</span>
  <span class="token literal-property property">resolve</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">alias</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">'public'</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../public'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 是否解析es6-promise.js，避免使用webpack的shimming process</span>
    <span class="token literal-property property">noParse</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">es6-promise\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token comment">// avoid webpack shimming process</span>
    <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.vue$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'vue-loader'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">compilerOptions</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">preserveWhitespace</span><span class="token operator">:</span> <span class="token boolean">false</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">exclude</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">node_modules</span><span class="token regex-delimiter">/</span></span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(png|jpg|gif|svg)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'url-loader'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">limit</span><span class="token operator">:</span> <span class="token number">10000</span><span class="token punctuation">,</span>
          <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'[name].[ext]?[hash]'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.styl(us)?$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">use</span><span class="token operator">:</span> isProd
          <span class="token operator">?</span> ExtractTextPlugin<span class="token punctuation">.</span><span class="token function">extract</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
              <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                  <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'css-loader'</span><span class="token punctuation">,</span>
                  <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">minimize</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string">'stylus-loader'</span>
              <span class="token punctuation">]</span><span class="token punctuation">,</span>
              <span class="token literal-property property">fallback</span><span class="token operator">:</span> <span class="token string">'vue-style-loader'</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'vue-style-loader'</span><span class="token punctuation">,</span> <span class="token string">'css-loader'</span><span class="token punctuation">,</span> <span class="token string">'stylus-loader'</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 是否显示性能提示</span>
  <span class="token literal-property property">performance</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">hints</span><span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> isProd
    <span class="token operator">?</span> <span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">VueLoaderPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// vue-loader 插件</span>
        <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>optimize<span class="token punctuation">.</span>UglifyJsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment">// JS 代码压缩插件</span>
          <span class="token literal-property property">compress</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">warnings</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>optimize<span class="token punctuation">.</span>ModuleConcatenationPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 代码优化插件</span>
        <span class="token keyword">new</span> <span class="token class-name">ExtractTextPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment">// 提取 CSS 代码插件</span>
          <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'common.[chunkhash].css'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">]</span>
    <span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">VueLoaderPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">FriendlyErrorsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 错误处理插件</span>
      <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br></div></div><h3 id="webpack-server-config"><a href="#webpack-server-config" class="header-anchor">#</a> <strong><code>webpack.server.config</code></strong></h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> merge <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> base <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.base.config'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> nodeExternals <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-node-externals'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> VueSSRServerPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-server-renderer/server-plugin'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// 这允许 webpack 以 Node 适用方式(Node-appropriate fashion)处理动态导入(dynamic import)，</span>
  <span class="token comment">// 并且还会在编译 Vue 组件时，告知 `vue-loader` 输送面向服务器代码(server-oriented code)。</span>
  <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">'node'</span><span class="token punctuation">,</span>
  <span class="token comment">// 对 bundle renderer 提供 source map 支持</span>
  <span class="token literal-property property">devtool</span><span class="token operator">:</span> <span class="token string">'#source-map'</span><span class="token punctuation">,</span>
  <span class="token comment">// 将 entry 指向应用程序的 server entry 文件</span>
  <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token string">'./src/entry-server.js'</span><span class="token punctuation">,</span>
  <span class="token comment">// 此处告知 server bundle 使用 Node 风格导出模块(Node-style exports)</span>
  <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'server-bundle.js'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">libraryTarget</span><span class="token operator">:</span> <span class="token string">'commonjs2'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 指定别名</span>
  <span class="token literal-property property">resolve</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">alias</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">'create-api'</span><span class="token operator">:</span> <span class="token string">'./create-api-server.js'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// https://webpack.js.org/configuration/externals/#function</span>
  <span class="token comment">// https://github.com/liady/webpack-node-externals</span>
  <span class="token comment">// 外置化应用程序依赖模块。可以使服务器构建速度更快，并生成较小的 bundle 文件。</span>
  <span class="token literal-property property">externals</span><span class="token operator">:</span> <span class="token function">nodeExternals</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  	<span class="token comment">// 不要外置化 webpack 需要处理的依赖模块。</span>
    <span class="token comment">// 你可以在这里添加更多的文件类型。例如，未处理 *.vue 原始文件，</span>
    <span class="token comment">// 你还应该将修改 `global`（例如 polyfill）的依赖模块列入白名单</span>
    <span class="token literal-property property">whitelist</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">// 这是将服务器的整个输出</span>
  <span class="token comment">// 构建为单个 JSON 文件的插件。</span>
  <span class="token comment">// 默认文件名为 `vue-ssr-server-bundle.json`</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token string-property property">'process.env.NODE_ENV'</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">||</span> <span class="token string">'development'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string-property property">'process.env.VUE_ENV'</span><span class="token operator">:</span> <span class="token string">'&quot;server&quot;'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">VueSSRServerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p>通过以上 webpack 构建 <code>entry-server.js</code> 文件后，将生成 <code>vue-ssr-server-bundle.json</code> 文件。</p> <p>在生成 <code>vue-ssr-server-bundle.json</code> 之后，在 <code>server.js</code> 文件中，只需将文件路径传递给 <code>createBundleRenderer</code>方法：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> createBundleRenderer <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-server-renderer'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> renderer <span class="token operator">=</span> <span class="token function">createBundleRenderer</span><span class="token punctuation">(</span><span class="token string">'/path/to/vue-ssr-server-bundle.json'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// ……renderer 的其他选项</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="webpack-client-config"><a href="#webpack-client-config" class="header-anchor">#</a> <strong><code>webpack.client.config</code></strong></h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> merge <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> base <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.base.config'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> SWPrecachePlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sw-precache-webpack-plugin'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> VueSSRClientPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-server-renderer/client-plugin'</span><span class="token punctuation">)</span>

<span class="token comment">// 合并基础配置和当前配置</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 客户端入口文件</span>
    <span class="token literal-property property">app</span><span class="token operator">:</span> <span class="token string">'./src/entry-client.js'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">resolve</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 解析别名</span>
    <span class="token literal-property property">alias</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">'create-api'</span><span class="token operator">:</span> <span class="token string">'./create-api-client.js'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// strip dev-only code in Vue source</span>
    <span class="token comment">// 定义环境变量</span>
    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token string-property property">'process.env.NODE_ENV'</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">||</span> <span class="token string">'development'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string-property property">'process.env.VUE_ENV'</span><span class="token operator">:</span> <span class="token string">'&quot;client&quot;'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// extract vendor chunks for better caching</span>
    <span class="token comment">// 提取公共代码</span>
    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>optimize<span class="token punctuation">.</span>CommonsChunkPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'vendor'</span><span class="token punctuation">,</span>
      <span class="token function-variable function">minChunks</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// a module is extracted into the vendor chunk if...</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>
          <span class="token comment">// it's inside node_modules</span>
          <span class="token operator">/</span>node_modules<span class="token operator">/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>context<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
          <span class="token comment">// and not a CSS file (due to extract-text-webpack-plugin limitation)</span>
          <span class="token operator">!</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>request<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// 重要信息：这将 webpack 运行时分离到一个引导 chunk 中，以便可以在之后正确注入异步 chunk。</span>
    <span class="token comment">// 这也为你的 应用程序/vendor 代码提供了更好的缓存。</span>
    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>optimize<span class="token punctuation">.</span>CommonsChunkPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'manifest'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// 此插件在输出目录中生成 `vue-ssr-client-manifest.json`。</span>
    <span class="token keyword">new</span> <span class="token class-name">VueSSRClientPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 如果是生产环境，添加service worker</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  config<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
    <span class="token comment">// auto generate service worker</span>
    <span class="token comment">// 用于在构建过程中自动生成Service Worker（服务worker）文件</span>
    <span class="token keyword">new</span> <span class="token class-name">SWPrecachePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">cacheId</span><span class="token operator">:</span> <span class="token string">'vue-hn'</span><span class="token punctuation">,</span><span class="token comment">// 缓存ID，用于识别不同的预缓存配置。</span>
      <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'service-worker.js'</span><span class="token punctuation">,</span><span class="token comment">// 服务worker文件的名称。</span>
      <span class="token literal-property property">minify</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token comment">// 是否对服务worker文件进行压缩。</span>
      <span class="token literal-property property">dontCacheBustUrlsMatching</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span><span class="token comment">//避免缓存 bust 的 URL 模式。</span>
      <span class="token literal-property property">staticFileGlobsIgnorePatterns</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.map$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.json$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">//忽略的静态文件 glob 模式。</span>
      <span class="token literal-property property">runtimeCaching</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token comment">//运行时缓存配置。</span>
        <span class="token punctuation">{</span>
          <span class="token literal-property property">urlPattern</span><span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
          <span class="token literal-property property">handler</span><span class="token operator">:</span> <span class="token string">'networkFirst'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token literal-property property">urlPattern</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\/(top|new|show|ask|jobs)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
          <span class="token literal-property property">urlPattern</span><span class="token operator">:</span> <span class="token string">'/top'</span><span class="token punctuation">,</span>
          <span class="token literal-property property">handler</span><span class="token operator">:</span> <span class="token string">'networkFirst'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token literal-property property">urlPattern</span><span class="token operator">:</span> <span class="token string">'/new'</span><span class="token punctuation">,</span>
          <span class="token literal-property property">handler</span><span class="token operator">:</span> <span class="token string">'networkFirst'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token literal-property property">urlPattern</span><span class="token operator">:</span> <span class="token string">'/show'</span><span class="token punctuation">,</span>
          <span class="token literal-property property">handler</span><span class="token operator">:</span> <span class="token string">'networkFirst'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token literal-property property">urlPattern</span><span class="token operator">:</span> <span class="token string">'/ask'</span><span class="token punctuation">,</span>
          <span class="token literal-property property">handler</span><span class="token operator">:</span> <span class="token string">'networkFirst'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token literal-property property">urlPattern</span><span class="token operator">:</span> <span class="token string">'/jobs'</span><span class="token punctuation">,</span>
          <span class="token literal-property property">handler</span><span class="token operator">:</span> <span class="token string">'networkFirst'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token literal-property property">urlPattern</span><span class="token operator">:</span> <span class="token string">'/item/:id'</span><span class="token punctuation">,</span>
          <span class="token literal-property property">handler</span><span class="token operator">:</span> <span class="token string">'networkFirst'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token literal-property property">urlPattern</span><span class="token operator">:</span> <span class="token string">'/user/:id'</span><span class="token punctuation">,</span>
          <span class="token literal-property property">handler</span><span class="token operator">:</span> <span class="token string">'networkFirst'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> config
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br></div></div><blockquote><p>以下是配置的主要原理：</p> <ol><li>原理：这段代码使用了 <code>webpack-merge</code> 模块来合并 base 配置和具体的配置项。这样可以确保在合并过程中不会覆盖或添加重复的配置项。</li> <li>注意事项：
<ul><li>确保已经安装了所需的依赖包，包括 <code>webpack</code>、<code>webpack-merge</code>、<code>sw-precache-webpack-plugin</code> 和 <code>vue-server-renderer</code> 等。</li> <li>配置文件应该位于项目的 <code>webpack.config.js</code> 文件中。</li> <li>配置文件应该使用 ES6 的模块导出而不是直接导出。</li> <li>对于 <code>SWPrecachePlugin</code> 的配置，建议参考其官方文档进行定制。</li></ul></li></ol></blockquote> <p>通过以上客户端构建 <code>client-entry.js</code> 文件后，生成客户端构建清单 (client build manifest) <code>clientManifest</code>，使用客户端清单 (client manifest) 和服务器 bundle(server bundle)，renderer 现在具有了<em>服务器和客户端</em>的构建信息，因此它可以自动推断和注入<a href="https://css-tricks.com/prefetching-preloading-prebrowsing/" target="_blank" rel="noopener noreferrer">资源预加载 / 数据预取指令(preload / prefetch directive) (opens new window)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，以及 css 链接 / script 标签到所渲染的 HTML。</p> <p>好处是双重的：</p> <ol><li>在生成的文件名中有哈希时，可以取代 <code>html-webpack-plugin</code> 来注入正确的资源 URL。</li> <li>在通过 webpack 的按需代码分割特性渲染 bundle 时，我们可以确保对 chunk 进行最优化的资源预加载/数据预取，并且还可以将所需的异步 chunk 智能地注入为 <code>&lt;script&gt;</code> 标签，以避免客户端的瀑布式请求 (waterfall request)，以及改善可交互时间 (TTI - time-to-interactive)。</li></ol> <p>通过以上构建出的客户端清单 (client manifest) 以及页面模板，在 <code>server.js</code> 中创建渲染器，渲染 HTML 页面：</p> <p><code>server.js</code> 文件部分代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> createBundleRenderer <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-server-renderer'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> template <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'/path/to/template.html'</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> serverBundle <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'/path/to/vue-ssr-server-bundle.json'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> clientManifest <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'/path/to/vue-ssr-client-manifest.json'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> renderer <span class="token operator">=</span> <span class="token function">createBundleRenderer</span><span class="token punctuation">(</span>serverBundle<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  template<span class="token punctuation">,</span>
  clientManifest
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>通过以上设置，使用代码分割特性构建后的服务器渲染的 HTML 代码，将看起来如下（所有都是自动注入）：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 用于当前渲染的 chunk 会被资源预加载(preload) --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>preload<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/manifest.js<span class="token punctuation">&quot;</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>script<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>preload<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/main.js<span class="token punctuation">&quot;</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>script<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>preload<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/0.js<span class="token punctuation">&quot;</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>script<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 未用到的异步 chunk 会被数据预取(prefetch)（次要优先级） --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>prefetch<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/1.js<span class="token punctuation">&quot;</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>script<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 应用程序内容 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">data-server-rendered</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>async<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- manifest chunk 优先 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/manifest.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 在主 chunk 之前注入异步 chunk --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/0.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/main.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="setup-dev-server"><a href="#setup-dev-server" class="header-anchor">#</a> <strong><code>setup-dev-server</code></strong></h3> <p>该文件主要用于构建本地开发服务，在 Node HTTP 服务中，使用 <code>webpack-dev-middleware</code> 启动一个本地开发服务。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token constant">MFS</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'memory-fs'</span><span class="token punctuation">)</span><span class="token comment">//内存文件系统，用于在内存中模拟文件系统，常用于单元测试</span>
<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> chokidar <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'chokidar'</span><span class="token punctuation">)</span><span class="token comment">//一个文件监听库，用于在文件发生变化时触发事件。Webpack的watch模式会使用这个库来监听文件变化。</span>
<span class="token keyword">const</span> clientConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.client.config'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> serverConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.server.config'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">readFile</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fs<span class="token punctuation">,</span> file</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 使用fs.readFileSync读取文件，并使用utf-8编码</span>
    <span class="token keyword">return</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>clientConfig<span class="token punctuation">.</span>output<span class="token punctuation">.</span>path<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">setupDevServer</span><span class="token punctuation">(</span><span class="token parameter">app<span class="token punctuation">,</span> templatePath<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 声明变量</span>
  <span class="token keyword">let</span> bundle
  <span class="token keyword">let</span> template
  <span class="token keyword">let</span> clientManifest

  <span class="token keyword">let</span> ready
  <span class="token comment">/**
   * 创建一个名为 readyPromise 的 Promise 对象，该对象的状态为 pending，并在未来的某个时间点执行 resolve 方法。
   * 这个 Promise 是为了在未来的某个时间点，如果其他依赖这个 Promise 的代码还没有准备好，那么就可以通过 await 或 then 来等待这个 Promise 被执行。
   * 创建一个异步操作，但是在其他代码没有准备好之前，不需要等待其完成。
   * 使用await关键字来等待一个Promise的结果，或者在then方法中处理Promise的成功解决。
   * 作为模块导入时的延迟加载Promise，确保模块在加载时不会因为其他依赖而阻塞。
   */</span>
  <span class="token keyword">const</span> readyPromise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> ready <span class="token operator">=</span> r <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 判断 bundle 和 clientManifest 是否存在，存在则执行 ready 函数，并调用cb函数，传入 bundle 和 clientManifest</span>
  <span class="token comment">// 通过 webpack 构建服务端渲染代码生成 bundle，构建客户端代码生成 clientManifest</span>
  <span class="token keyword">const</span> <span class="token function-variable function">update</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bundle <span class="token operator">&amp;&amp;</span> clientManifest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token function">cb</span><span class="token punctuation">(</span>bundle<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        template<span class="token punctuation">,</span>
        clientManifest
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// read template from disk and watch</span>
  template <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>templatePath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
  <span class="token comment">//监听模板变化，在文件发生变化时，读取模板文件</span>
  chokidar<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span>templatePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    template <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>templatePath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'index.html template updated.'</span><span class="token punctuation">)</span>
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// modify client config to work with hot middleware</span>
  <span class="token comment">// 修改热更新模块的客户端配置</span>
  clientConfig<span class="token punctuation">.</span>entry<span class="token punctuation">.</span>app <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'webpack-hot-middleware/client'</span><span class="token punctuation">,</span> clientConfig<span class="token punctuation">.</span>entry<span class="token punctuation">.</span>app<span class="token punctuation">]</span>
  clientConfig<span class="token punctuation">.</span>output<span class="token punctuation">.</span>filename <span class="token operator">=</span> <span class="token string">'[name].js'</span>
  clientConfig<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>HotModuleReplacementPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 使用热更新插件</span>
    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>NoEmitOnErrorsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>

  <span class="token comment">// dev middleware</span>
  <span class="token keyword">const</span> clientCompiler <span class="token operator">=</span> <span class="token function">webpack</span><span class="token punctuation">(</span>clientConfig<span class="token punctuation">)</span>
  <span class="token comment">// 使用开发服务插件</span>
  <span class="token keyword">const</span> devMiddleware <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-dev-middleware'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>clientCompiler<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">publicPath</span><span class="token operator">:</span> clientConfig<span class="token punctuation">.</span>output<span class="token punctuation">.</span>publicPath<span class="token punctuation">,</span>
    <span class="token literal-property property">noInfo</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>devMiddleware<span class="token punctuation">)</span>
  <span class="token comment">// 监听插件完成事件，执行回调，更新文件</span>
  clientCompiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'done'</span><span class="token punctuation">,</span> <span class="token parameter">stats</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    stats <span class="token operator">=</span> stats<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    stats<span class="token punctuation">.</span>errors<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>
    stats<span class="token punctuation">.</span>warnings<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span>
    clientManifest <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token function">readFile</span><span class="token punctuation">(</span>
      devMiddleware<span class="token punctuation">.</span>fileSystem<span class="token punctuation">,</span>
      <span class="token string">'vue-ssr-client-manifest.json'</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// hot middleware</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-hot-middleware'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>clientCompiler<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">heartbeat</span><span class="token operator">:</span> <span class="token number">5000</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token comment">// watch and update server renderer</span>
  <span class="token keyword">const</span> serverCompiler <span class="token operator">=</span> <span class="token function">webpack</span><span class="token punctuation">(</span>serverConfig<span class="token punctuation">)</span>
  <span class="token keyword">const</span> mfs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MFS</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  serverCompiler<span class="token punctuation">.</span>outputFileSystem <span class="token operator">=</span> mfs
  serverCompiler<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> stats</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err
    stats <span class="token operator">=</span> stats<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span>

    <span class="token comment">// read bundle generated by vue-ssr-webpack-plugin</span>
    bundle <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token function">readFile</span><span class="token punctuation">(</span>mfs<span class="token punctuation">,</span> <span class="token string">'vue-ssr-server-bundle.json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> readyPromise
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br></div></div><blockquote><p>以上本地开发服务主要逻辑：</p> <ol><li>使用客户端模块热替换插件 <code>webpack-hot-middleware/client</code>  和 本地开发服务插件 <code>webpack-dev-middleware</code> 启动一个本地开发服务，监听模板文件变化；</li> <li>使用本地开发服务插件 <code>webpack-dev-middleware</code> 启动一个本地开发服务，监听模板文件变化服务端文件变化；</li> <li>文件变化后，传入重新编译产物：客户端清单文件<code>vue-ssr-client-manifest.json</code> 和  <code>vue-ssr-server-bundle.json</code> 服务端构建文件，执行 <code>update</code> 方法， <code>update</code> 方法中执行回调（回调为 <code>server.js</code>  中传入，实际为重新渲染 HTML 页面方法 <code>createRenderer</code>）</li></ol></blockquote></div> <!----> <div class="content__content-bottom"></div> <footer class="page-meta"><!----> <div class="meta-item update-time"><span class="label">Last update:</span> <span class="info">February 6, 2024 11:49</span></div> <div class="meta-item contributors"><span class="label">Contributors: </span> <span class="info"><span title="email: 596777598@qq.com" class="contributor">
          sewar
        </span> <!----></span></div></footer> <!----> <!----> <!----> <div class="content__page-bottom"></div></main> <!----></div><div class="global-ui"><!----><div id="pwa-install"><!----> <div id="install-modal-wrapper" style="display:none;"><div class="background"></div> <div class="install-modal"><div class="header"><button aria-label="Close" class="close-button"><svg width="23" height="22" xmlns="http://www.w3.org/2000/svg" class="icon close-icon"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.12.358a1.224 1.224 0 011.729 0l8.92 8.914L20.686.358a1.224 1.224 0 011.73 1.728L13.497 11l8.92 8.913a1.222 1.222 0 11-1.73 1.729l-8.919-8.913-8.92 8.913a1.224 1.224 0 01-1.729-1.729L10.04 11l-8.92-8.914a1.222 1.222 0 010-1.728z" fill="currentColor"></path></svg></button> <div class="logo"><!----> <div class="title"><h1></h1> <p class="desc">This app can be installed on your PC or mobile device.  This will allow this web app to look and behave like any other installed app.  You will find it in your app lists and be able to pin it to your home screen, start menus or task bars.  This installed web app will also be able to safely interact with other apps and your operating system. </p></div></div></div> <div class="content"><div class="highlight"><!----> <!----></div> <div class="description"><h3>Description</h3> <p></p></div></div> <div class="button-wrapper"><button class="install-button">
        Install <span></span></button> <button class="cancel-button">
        Cancel
      </button></div></div></div></div><!----><div tabindex="-1" role="dialog" aria-hidden="true" class="pswp"><div class="pswp__bg"></div> <div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div> <div class="pswp__item"></div> <div class="pswp__item"></div></div> <div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div> <button title="Close" aria-label="Close" class="pswp__button pswp__button--close"></button> <button title="Share" aria-label="Share" class="pswp__button pswp__button--share"></button> <button title="Switch to full screen" aria-label="Switch to full screen" class="pswp__button pswp__button--fs"></button> <button title="Zoom in/out" aria-label="Zoom in/out" class="pswp__button pswp__button--zoom"></button> <div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div> <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div> <button title="Prev (Arrow Left)" aria-label="Prev (Arrow Left)" class="pswp__button pswp__button--arrow--left"></button> <button title="Next (Arrow Right)" aria-label="Next (Arrow Right)" class="pswp__button pswp__button--arrow--right"></button> <div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div></div></div>
    <script src="/myblog/assets/js/app.9d2b617a.js" defer></script><script src="/myblog/assets/js/layout-Layout.d2d4ce64.js" defer></script><script src="/myblog/assets/js/page-从零到一搭建SSR项目.855376fc.js" defer></script><script src="/myblog/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound~layout-components/Blog/BlogHome~layout-components/~2222f443.5835591a.js" defer></script>
  </body>
</html>
